<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Fractured Sky - Virtual Tabletop</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #0a0e1a;
            --bg-card: #151928;
            --bg-hover: #1f2537;
            --accent: #8b5cf6;
            --accent-secondary: #ec4899;
            --gold: #fbbf24;
            --text: #e5e7eb;
            --text-dim: #9ca3af;
            --border: rgba(139, 92, 246, 0.2);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
        }

        .header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .title {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--gold), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
        }

        .btn {
            padding: 0.6rem 1.2rem;
            background: var(--bg-hover);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--accent);
            border-color: var(--accent);
            transform: translateY(-1px);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            border: none;
            color: white;
        }

        .container {
            display: flex;
            height: calc(100vh - 70px);
        }

        .main-area {
            flex: 1;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }

        .tabletop {
            flex: 1;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        }

        .tabletop-header {
            padding: 1rem 1.5rem;
            background: var(--bg-hover);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .session-name {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            background: linear-gradient(135deg, var(--gold), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .slider {
            width: 120px;
            height: 4px;
            background: var(--bg-dark);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
        }

        .canvas-container {
            flex: 1;
            position: relative;
            background: radial-gradient(circle at center, #1a1f2e 0%, var(--bg-dark) 100%);
            overflow: hidden;
        }

        #mainCanvas {
            display: block;
            cursor: grab;
        }

        #mainCanvas:active {
            cursor: grabbing;
        }

        /* Stamp Sidebar */
        .stamp-sidebar {
            width: 280px;
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.3s;
            box-shadow: -5px 0 20px rgba(0,0,0,0.3);
        }

        .stamp-sidebar.open {
            transform: translateX(0);
        }

        .stamp-header {
            position: sticky;
            top: 0;
            background: var(--bg-hover);
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .stamp-content {
            padding: 1rem;
        }

        .stamp-category {
            margin-bottom: 1.5rem;
        }

        .stamp-category h4 {
            color: var(--gold);
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stamp-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }

        .stamp-item {
            aspect-ratio: 1;
            background: var(--bg-hover);
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .stamp-item:hover {
            transform: scale(1.1);
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.3);
        }

        .stamp-item.selected {
            border-color: var(--gold);
            background: rgba(251, 191, 36, 0.1);
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.4);
        }

        /* DM Panel */
        .dm-panel {
            width: 380px;
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.3s;
        }

        .dm-panel.open {
            transform: translateX(0);
        }

        .dm-header {
            position: sticky;
            top: 0;
            background: var(--bg-hover);
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .dm-content {
            padding: 1rem;
        }

        .section {
            background: var(--bg-hover);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s;
        }

        .section.active {
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
            background: rgba(139, 92, 246, 0.05);
        }

        .section h3 {
            margin-bottom: 0.75rem;
            color: var(--gold);
            font-size: 1rem;
        }

        .section.active h3 {
            color: var(--accent);
        }

        .tool-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin: 0.75rem 0;
        }

        .tool-btn {
            padding: 0.75rem;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .tool-btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent);
        }

        .tool-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .control-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin: 0.75rem 0;
        }

        .control-row label {
            min-width: 60px;
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        input[type="color"] {
            width: 50px;
            height: 36px;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
        }

        .grid-selector {
            background: var(--bg-dark);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 2px solid var(--border);
        }

        .grid-selector.active {
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.3);
        }

        .grid-info {
            font-size: 0.9rem;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
        }

        .grid-info .current {
            color: var(--accent);
            font-weight: 600;
        }

        .grid-nav {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        #mapCanvas {
            width: 100%;
            height: 250px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: white;
            cursor: crosshair;
            margin: 0.5rem 0;
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .modal-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .modal-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-dim);
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.95rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            color: #ef4444;
            padding: 0.75rem;
            border-radius: 6px;
            margin: 1rem 0;
            display: none;
        }

        .error.show {
            display: block;
        }

        .player-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            padding: 0.75rem 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            transform: translateY(100%);
            transition: transform 0.3s;
            z-index: 50;
        }

        .player-bar.show {
            transform: translateY(0);
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-hover);
            border-radius: 8px;
        }

        .player-tokens {
            flex: 1;
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
        }

        .token {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border: 2px solid var(--border);
            cursor: move;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .token:hover {
            transform: scale(1.1);
            border-color: var(--accent);
        }

        .player-login-btn {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .player-login-btn:hover {
            transform: scale(1.1);
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">âœ¨ THE FRACTURED SKY</div>
        <div class="header-actions">
            <button class="btn" onclick="saveGame()">ğŸ’¾ Save</button>
            <button class="btn" onclick="loadGame()">ğŸ“‚ Load</button>
            <button class="btn btn-primary" onclick="openDM()">ğŸ­ DM Controls</button>
        </div>
    </div>

    <div class="container">
        <div class="main-area">
            <div class="tabletop">
                <div class="tabletop-header">
                    <div class="session-name">The Fractured Sky</div>
                    <div class="zoom-controls">
                        <span style="color: var(--text-dim); font-size: 0.9rem;">Zoom:</span>
                        <input type="range" class="slider" id="zoomSlider" min="25" max="200" value="100" oninput="setZoom(this.value)">
                        <span id="zoomValue" style="min-width: 50px; font-size: 0.9rem;">100%</span>
                    </div>
                </div>
                <div class="canvas-container" id="canvasContainer">
                    <canvas id="mainCanvas"></canvas>
                </div>
            </div>
        </div>

        <!-- Stamp Sidebar -->
        <div class="stamp-sidebar" id="stampSidebar">
            <div class="stamp-header">
                <h3 style="color: var(--gold);">ğŸ° Stamp Library</h3>
                <button class="btn" onclick="closeStamps()">âœ•</button>
            </div>
            <div class="stamp-content">
                <div class="stamp-category">
                    <h4>ğŸª¨ Terrain Textures</h4>
                    <div class="stamp-grid">
                        <div class="stamp-item" onclick="selectStamp('â¬œ')" title="Stone">â¬œ</div>
                        <div class="stamp-item" onclick="selectStamp('â¬›')" title="Dark Stone">â¬›</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸŸ«')" title="Dirt">ğŸŸ«</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸŸ¤')" title="Dark Dirt">ğŸŸ¤</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸª¨')" title="Gravel/Rock">ğŸª¨</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸŸ©')" title="Grass">ğŸŸ©</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸŒ¿')" title="Dense Grass">ğŸŒ¿</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸŸ¦')" title="Water">ğŸŸ¦</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸŒŠ')" title="Deep Water">ğŸŒŠ</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸŸ¨')" title="Sand">ğŸŸ¨</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸ–ï¸')" title="Beach">ğŸ–ï¸</div>
                        <div class="stamp-item" onclick="selectStamp('â„ï¸')" title="Snow/Ice">â„ï¸</div>
                    </div>
                </div>
                <div class="stamp-category">
                    <h4>ğŸŒ‰ Structures & Paths</h4>
                    <div class="stamp-grid">
                        <div class="stamp-item" onclick="selectStamp('ğŸŒ‰')" title="Bridge">ğŸŒ‰</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸ›¤ï¸')" title="Road/Path">ğŸ›¤ï¸</div>
                        <div class="stamp-item" onclick="selectStamp('â¬œ')" title="Stone Path">â¬œ</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸªµ')" title="Wood Planks">ğŸªµ</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸ§±')" title="Brick">ğŸ§±</div>
                        <div class="stamp-item" onclick="selectStamp('â›²')" title="Fountain">â›²</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸšª')" title="Door">ğŸšª</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸªŸ')" title="Window">ğŸªŸ</div>
                    </div>
                </div>
                <div class="stamp-category">
                    <h4>ğŸ”ï¸ Natural Features</h4>
                    <div class="stamp-grid">
                        <div class="stamp-item" onclick="selectStamp('ğŸ”ï¸')">ğŸ”ï¸</div>
                        <div class="stamp-item" onclick="selectStamp('â›°ï¸')">â›°ï¸</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸ—»')">ğŸ—»</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸŒ‹')">ğŸŒ‹</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸï¸')">ğŸï¸</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸï¸')">ğŸï¸</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸœï¸')">ğŸœï¸</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸª¨')">ğŸª¨</div>
                    </div>
                </div>
                <div class="stamp-category">
                    <h4>ğŸŒ² Vegetation</h4>
                    <div class="stamp-grid">
                        <div class="stamp-item" onclick="selectStamp('ğŸŒ²')">ğŸŒ²</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸŒ³')">ğŸŒ³</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸŒ´')">ğŸŒ´</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸ‹')">ğŸ‹</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸ')">ğŸ</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸŒ¾')">ğŸŒ¾</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸƒ')">ğŸƒ</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸ„')">ğŸ„</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸŒ»')">ğŸŒ»</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸŒ¹')">ğŸŒ¹</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸŒº')">ğŸŒº</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸŒ·')">ğŸŒ·</div>
                    </div>
                </div>
                <div class="stamp-category">
                    <h4>ğŸ° Buildings</h4>
                    <div class="stamp-grid">
                        <div class="stamp-item" onclick="selectStamp('ğŸ°')">ğŸ°</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸ¯')">ğŸ¯</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸ›ï¸')">ğŸ›ï¸</div>
                        <div class="stamp-item" onclick="selectStamp('â›ª')">â›ª</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸ•Œ')">ğŸ•Œ</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸ˜ï¸')">ğŸ˜ï¸</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸšï¸')">ğŸšï¸</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸ ')">ğŸ </div>
                        <div class="stamp-item" onclick="selectStamp('ğŸ¡')">ğŸ¡</div>
                        <div class="stamp-item" onclick="selectStamp('â›º')">â›º</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸ•ï¸')">ğŸ•ï¸</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸ—¼')">ğŸ—¼</div>
                    </div>
                </div>
                <div class="stamp-category">
                    <h4>âš”ï¸ Objects & Items</h4>
                    <div class="stamp-grid">
                        <div class="stamp-item" onclick="selectStamp('âš”ï¸')">âš”ï¸</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸ—¡ï¸')">ğŸ—¡ï¸</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸ›¡ï¸')">ğŸ›¡ï¸</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸ¹')">ğŸ¹</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸ”®')">ğŸ”®</div>
                        <div class="stamp-item" onclick="selectStamp('âš—ï¸')">âš—ï¸</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸ“œ')">ğŸ“œ</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸ’')">ğŸ’</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸ‘‘')">ğŸ‘‘</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸ•¯ï¸')">ğŸ•¯ï¸</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸ”¥')">ğŸ”¥</div>
                        <div class="stamp-item" onclick="selectStamp('âš¡')">âš¡</div>
                    </div>
                </div>
                <div class="stamp-category">
                    <h4>ğŸ‰ Creatures</h4>
                    <div class="stamp-grid">
                        <div class="stamp-item" onclick="selectStamp('ğŸ‰')">ğŸ‰</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸ²')">ğŸ²</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸ¦…')">ğŸ¦…</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸ¦‰')">ğŸ¦‰</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸ¦‡')">ğŸ¦‡</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸº')">ğŸº</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸ¦')">ğŸ¦</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸ»')">ğŸ»</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸ¦Œ')">ğŸ¦Œ</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸ—')">ğŸ—</div>
                        <div class="stamp-item" onclick="selectStamp('ğŸ’€')">ğŸ’€</div>
                        <div class="stamp-item" onclick="selectStamp('â˜ ï¸')">â˜ ï¸</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DM Panel -->
        <div class="dm-panel" id="dmPanel">
            <div class="dm-header">
                <h2>ğŸ­ Dungeon Master</h2>
                <button class="btn" onclick="closeDM()">âœ•</button>
            </div>
            <div class="dm-content">
                <div class="section">
                    <h3>ğŸ“¥ Import Maps</h3>
                    <a href="https://inkarnate.com/maps/" target="_blank" class="btn btn-primary" style="width: 100%; text-decoration: none; display: block; text-align: center; margin-bottom: 0.5rem;">
                        ğŸ—ºï¸ Open Inkarnate
                    </a>
                    <a href="https://www.owlbear.rodeo/" target="_blank" class="btn btn-primary" style="width: 100%; text-decoration: none; display: block; text-align: center;">
                        ğŸ² Open Owlbear Rodeo
                    </a>
                </div>

                <div class="section" id="mapSection">
                    <h3>ğŸ—ºï¸ Grid Map Builder</h3>
                    
                    <div class="grid-selector active">
                        <div class="grid-info">
                            Building cell: <span class="current" id="currentCell">A1</span>
                        </div>
                        <div class="grid-nav">
                            <button class="btn" onclick="moveGrid(-1, 0)">â† Left</button>
                            <button class="btn" onclick="moveGrid(1, 0)">Right â†’</button>
                            <button class="btn" onclick="moveGrid(0, -1)">â†‘ Up</button>
                            <button class="btn" onclick="moveGrid(0, 1)">â†“ Down</button>
                        </div>
                    </div>

                    <div class="tool-grid">
                        <div class="tool-btn active" onclick="setTool('brush')" id="brushBtn">ğŸ–Œï¸<br>Brush</div>
                        <div class="tool-btn" onclick="setTool('fill')" id="fillBtn">ğŸª£<br>Fill</div>
                        <div class="tool-btn" onclick="setTool('eraser')" id="eraserBtn">ğŸ§¹<br>Erase</div>
                        <div class="tool-btn" onclick="setTool('stamp'); openStamps();" id="stampBtn">ğŸ°<br>Stamps</div>
                    </div>
                    <div class="control-row">
                        <label>Color:</label>
                        <input type="color" id="colorPicker" value="#4a7c59">
                    </div>
                    <div class="control-row">
                        <label>Size:</label>
                        <input type="range" class="slider" id="sizeSlider" min="1" max="30" value="8" oninput="setSize(this.value)" style="flex: 1;">
                        <span id="sizeValue">8px</span>
                    </div>
                    <canvas id="mapCanvas" width="400" height="400"></canvas>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="submitCell()" style="flex: 1;">âœ“ Submit Cell</button>
                        <button class="btn" onclick="clearCell()">Clear</button>
                    </div>
                </div>

                <div class="section" id="fogSection">
                    <h3>ğŸŒ«ï¸ Fog of War</h3>
                    <div class="control-row">
                        <label>Size:</label>
                        <input type="range" class="slider" id="fogSize" min="20" max="150" value="60" oninput="setFogSize(this.value)" style="flex: 1;">
                        <span id="fogSizeValue">60px</span>
                    </div>
                    <div class="control-row">
                        <label>
                            <input type="checkbox" id="revealMode" checked> Reveal
                        </label>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="toggleFog()" id="fogBtn">Enable Fog</button>
                        <button class="btn" onclick="resetFog()">Reset</button>
                    </div>
                </div>

                <div class="section" id="tokensSection">
                    <h3>ğŸ² Tokens</h3>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="addToken('#e74c3c', 'âš”ï¸')">âš”ï¸</button>
                        <button class="btn btn-primary" onclick="addToken('#3498db', 'ğŸ›¡ï¸')">ğŸ›¡ï¸</button>
                        <button class="btn btn-primary" onclick="addToken('#2ecc71', 'ğŸ¹')">ğŸ¹</button>
                        <button class="btn btn-primary" onclick="addToken('#9b59b6', 'ğŸ”®')">ğŸ”®</button>
                    </div>
                    <button class="btn" onclick="addCustomToken()" style="width: 100%; margin-top: 0.5rem;">+ Custom Token</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="dmModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">ğŸ§™</div>
                <h2>Dungeon Master</h2>
            </div>
            <form onsubmit="dmLogin(event)">
                <div class="form-group">
                    <label>USERNAME</label>
                    <input type="text" id="dmUser" placeholder="Enter username" autocomplete="off" required>
                </div>
                <div class="form-group">
                    <label>PASSWORD</label>
                    <input type="password" id="dmPass" placeholder="Enter password" autocomplete="off" required>
                </div>
                <div class="error" id="dmError">Invalid credentials</div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">ENTER</button>
                <button type="button" class="btn" onclick="closeDMModal()" style="width: 100%; margin-top: 0.5rem;">Cancel</button>
            </form>
        </div>
    </div>

    <div class="modal" id="playerModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">ğŸ‘¤</div>
                <h2>Player Login</h2>
            </div>
            <form onsubmit="playerLogin(event)">
                <div class="form-group">
                    <label>CHARACTER NAME</label>
                    <input type="text" id="playerName" placeholder="Enter your name" autocomplete="off" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">JOIN GAME</button>
                <button type="button" class="btn" onclick="closePlayerModal()" style="width: 100%; margin-top: 0.5rem;">Cancel</button>
            </form>
        </div>
    </div>

    <div class="player-bar" id="playerBar">
        <div class="player-info">
            <div style="width: 36px; height: 36px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">ğŸ‘¤</div>
            <span id="playerNameDisplay">Guest</span>
        </div>
        <div class="player-tokens" id="playerTokens"></div>
        <div style="display: flex; gap: 0.5rem;">
            <button class="btn" onclick="createPlayerToken()">+ New Token</button>
            <button class="btn" onclick="playerLogout()">Logout</button>
        </div>
    </div>

    <button class="player-login-btn" onclick="showPlayerLogin()" id="playerBtn">ğŸ‘¤</button>

    <input type="file" id="fileLoad" accept=".json" style="display: none;" onchange="handleLoad(event)">

    <script>
        // State
        let isDM = false;
        let currentPlayer = null;
        let zoom = 1;
        let panX = 0;
        let panY = 0;
        let tokens = [];
        let tool = 'brush';
        let color = '#4a7c59';
        let size = 8;
        let stamp = 'ğŸŒ²';
        let fogSize = 60;
        let currentMode = 'map';
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let dragToken = null;
        let playerTokens = [];
        
        // Grid system
        const GRID_SIZE = 400;
        const CELL_SIZE = 400;
        let currentGridX = 0;
        let currentGridY = 0;
        let gridCells = {};

        // Canvas
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const mapCanvas = document.getElementById('mapCanvas');
        const mapCtx = mapCanvas.getContext('2d');
        const fogCanvas = document.createElement('canvas');
        const fogCtx = fogCanvas.getContext('2d');

        function resizeCanvas() {
            const container = document.getElementById('canvasContainer');
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;
            fogCanvas.width = canvas.width;
            fogCanvas.height = canvas.height;
            
            panX = 0;
            panY = 0;
            
            draw();
        }

        function init() {
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            mapCtx.fillStyle = '#f5f5dc';
            mapCtx.fillRect(0, 0, mapCanvas.width, mapCanvas.height);
            fogCtx.fillStyle = 'rgba(0,0,0,0.9)';
            fogCtx.fillRect(0, 0, fogCanvas.width, fogCanvas.height);
            setMode('map');
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(panX, panY);
            ctx.scale(zoom, zoom);

            // Draw grid
            const gridStart = -2;
            const gridEnd = 2;
            
            for (let gx = gridStart; gx <= gridEnd; gx++) {
                for (let gy = gridStart; gy <= gridEnd; gy++) {
                    const x = gx * GRID_SIZE;
                    const y = gy * GRID_SIZE;
                    
                    // Cell background
                    ctx.fillStyle = '#1a1f2e';
                    ctx.fillRect(x, y, GRID_SIZE, GRID_SIZE);
                    
                    // Cell content
                    const key = `${gx},${gy}`;
                    if (gridCells[key]) {
                        ctx.drawImage(gridCells[key], x, y, GRID_SIZE, GRID_SIZE);
                    }
                    
                    // Grid lines
                    ctx.strokeStyle = '#2a2f3e';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x, y, GRID_SIZE, GRID_SIZE);
                    
                    // Current cell highlight
                    if (gx === currentGridX && gy === currentGridY && isDM) {
                        ctx.strokeStyle = '#8b5cf6';
                        ctx.lineWidth = 4;
                        ctx.strokeRect(x, y, GRID_SIZE, GRID_SIZE);
                    }
                }
            }

            // Tokens
            tokens.forEach(t => {
                ctx.fillStyle = t.color;
                ctx.beginPath();
                ctx.arc(t.x, t.y, 30, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#fbbf24';
                ctx.lineWidth = 3;
                ctx.stroke();
                ctx.fillStyle = '#fff';
                ctx.font = '32px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(t.icon, t.x, t.y);
                if (t.owner) {
                    ctx.fillStyle = '#8b5cf6';
                    ctx.font = '12px Inter';
                    ctx.fillText(t.owner, t.x, t.y + 45);
                }
            });

            ctx.restore();

            // Fog
            ctx.save();
            ctx.translate(panX, panY);
            ctx.scale(zoom, zoom);
            ctx.drawImage(fogCanvas, 0, 0);
            ctx.restore();
        }

        // Grid Navigation
        function moveGrid(dx, dy) {
            currentGridX += dx;
            currentGridY += dy;
            updateGridDisplay();
            draw();
        }

        function updateGridDisplay() {
            const cols = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            const col = cols[Math.abs(currentGridX % 26)];
            const row = Math.abs(currentGridY) + 1;
            document.getElementById('currentCell').textContent = col + row;
        }

        function submitCell() {
            const key = `${currentGridX},${currentGridY}`;
            const cellCanvas = document.createElement('canvas');
            cellCanvas.width = CELL_SIZE;
            cellCanvas.height = CELL_SIZE;
            const cellCtx = cellCanvas.getContext('2d');
            cellCtx.drawImage(mapCanvas, 0, 0);
            gridCells[key] = cellCanvas;
            draw();
            alert(`Cell submitted! Move to another cell to continue building.`);
        }

        function clearCell() {
            mapCtx.fillStyle = '#f5f5dc';
            mapCtx.fillRect(0, 0, mapCanvas.width, mapCanvas.height);
        }

        // Modes
        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            if (mode === 'map') {
                const mapSection = document.getElementById('mapSection');
                if (mapSection) mapSection.classList.add('active');
                canvas.style.cursor = 'grab';
            } else if (mode === 'fog') {
                const fogSection = document.getElementById('fogSection');
                if (fogSection) fogSection.classList.add('active');
                canvas.style.cursor = 'crosshair';
            } else if (mode === 'token') {
                const tokenSection = document.getElementById('tokensSection');
                if (tokenSection) tokenSection.classList.add('active');
                canvas.style.cursor = 'default';
            }
            
            updateFogButton();
        }

        function updateFogButton() {
            const btn = document.getElementById('fogBtn');
            if (currentMode === 'fog') {
                btn.textContent = 'ğŸŒ«ï¸ Fog Active';
                btn.classList.add('btn-primary');
            } else {
                btn.textContent = 'Enable Fog';
                btn.classList.remove('btn-primary');
            }
        }

        // Tools
        function setTool(t) {
            tool = t;
            setMode('map');
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById(t + 'Btn');
            if (btn) btn.classList.add('active');
        }

        function setSize(v) {
            size = v;
            document.getElementById('sizeValue').textContent = v + 'px';
        }

        // Stamps
        function openStamps() {
            document.getElementById('stampSidebar').classList.add('open');
            tool = 'stamp';
            setMode('map');
        }

        function closeStamps() {
            document.getElementById('stampSidebar').classList.remove('open');
        }

        function selectStamp(s) {
            stamp = s;
            document.querySelectorAll('.stamp-item').forEach(item => item.classList.remove('selected'));
            event.target.classList.add('selected');
            closeStamps();
            setTool('stamp');
        }

        document.getElementById('colorPicker').addEventListener('change', e => {
            color = e.target.value;
        });

        // Map Canvas Drawing
        mapCanvas.addEventListener('mousedown', e => {
            isDrawing = true;
            const rect = mapCanvas.getBoundingClientRect();
            const scaleX = mapCanvas.width / rect.width;
            const scaleY = mapCanvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            lastX = x;
            lastY = y;

            if (tool === 'brush') {
                mapCtx.beginPath();
                mapCtx.moveTo(x, y);
                mapCtx.strokeStyle = color;
                mapCtx.lineWidth = size;
                mapCtx.lineCap = 'round';
            } else if (tool === 'fill') {
                mapCtx.fillStyle = color;
                mapCtx.fillRect(0, 0, mapCanvas.width, mapCanvas.height);
            } else if (tool === 'stamp') {
                mapCtx.font = '48px Arial';
                mapCtx.fillText(stamp, x - 24, y + 12);
            } else if (tool === 'eraser') {
                mapCtx.globalCompositeOperation = 'destination-out';
                mapCtx.beginPath();
                mapCtx.moveTo(x, y);
                mapCtx.lineWidth = size;
            }
        });

        mapCanvas.addEventListener('mousemove', e => {
            if (!isDrawing) return;
            const rect = mapCanvas.getBoundingClientRect();
            const scaleX = mapCanvas.width / rect.width;
            const scaleY = mapCanvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            if (tool === 'brush') {
                mapCtx.lineTo(x, y);
                mapCtx.stroke();
            } else if (tool === 'eraser') {
                mapCtx.lineTo(x, y);
                mapCtx.stroke();
            }
        });

        mapCanvas.addEventListener('mouseup', () => {
            isDrawing = false;
            if (tool === 'eraser') {
                mapCtx.globalCompositeOperation = 'source-over';
            }
        });

        // Fog
        function setFogSize(v) {
            fogSize = v;
            document.getElementById('fogSizeValue').textContent = v + 'px';
        }

        function toggleFog() {
            if (currentMode === 'fog') {
                setMode('map');
            } else {
                setMode('fog');
            }
        }

        function resetFog() {
            fogCtx.fillStyle = 'rgba(0,0,0,0.9)';
            fogCtx.fillRect(0, 0, fogCanvas.width, fogCanvas.height);
            draw();
        }

        function applyFog(x, y) {
            const reveal = document.getElementById('revealMode').checked;
            if (reveal) {
                fogCtx.globalCompositeOperation = 'destination-out';
            } else {
                fogCtx.globalCompositeOperation = 'source-over';
                fogCtx.fillStyle = 'rgba(0,0,0,0.9)';
            }
            fogCtx.beginPath();
            fogCtx.arc(x, y, fogSize, 0, Math.PI * 2);
            fogCtx.fill();
            draw();
        }

        // Tokens
        function addToken(c, i) {
            setMode('token');
            tokens.push({ x: 200, y: 200, color: c, icon: i, owner: null });
            draw();
        }

        function addCustomToken() {
            setMode('token');
            const i = prompt('Emoji:', 'âš”ï¸') || 'âš”ï¸';
            const c = prompt('Color:', '#e74c3c') || '#e74c3c';
            addToken(c, i);
        }

        // Zoom
        function setZoom(v) {
            zoom = v / 100;
            document.getElementById('zoomValue').textContent = Math.round(v) + '%';
            draw();
        }

        // Canvas Interaction
        canvas.addEventListener('mousedown', e => {
            const rect = canvas.getBoundingClientRect();
            const mx = (e.clientX - rect.left - panX) / zoom;
            const my = (e.clientY - rect.top - panY) / zoom;

            if (currentMode === 'fog') {
                isDrawing = true;
                applyFog(mx, my);
                return;
            }

            if (currentMode === 'token' && currentPlayer) {
                dragToken = tokens.find(t => {
                    const dx = mx - t.x;
                    const dy = my - t.y;
                    return Math.sqrt(dx*dx + dy*dy) < 30;
                });

                if (dragToken) {
                    isDrawing = true;
                }
                return;
            }

            if (currentMode === 'map') {
                lastX = e.clientX;
                lastY = e.clientY;
                isDrawing = true;
            }
        });

        canvas.addEventListener('mousemove', e => {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            const mx = (e.clientX - rect.left - panX) / zoom;
            const my = (e.clientY - rect.top - panY) / zoom;

            if (currentMode === 'fog') {
                applyFog(mx, my);
                return;
            }

            if (currentMode === 'token' && dragToken) {
                dragToken.x = mx;
                dragToken.y = my;
                draw();
                return;
            }

            if (currentMode === 'map') {
                panX += e.clientX - lastX;
                panY += e.clientY - lastY;
                lastX = e.clientX;
                lastY = e.clientY;
                draw();
            }
        });

        canvas.addEventListener('mouseup', () => {
            isDrawing = false;
            dragToken = null;
        });

        canvas.addEventListener('dragover', e => e.preventDefault());
        canvas.addEventListener('drop', e => {
            e.preventDefault();
            try {
                const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                if (data.type === 'player') {
                    const rect = canvas.getBoundingClientRect();
                    const x = (e.clientX - rect.left - panX) / zoom;
                    const y = (e.clientY - rect.top - panY) / zoom;
                    tokens.push({ x, y, color: data.token.color, icon: data.token.icon, owner: currentPlayer });
                    draw();
                }
            } catch {}
        });

        // DM
        function openDM() {
            document.getElementById('dmModal').classList.add('active');
        }

        function closeDMModal() {
            document.getElementById('dmModal').classList.remove('active');
            document.getElementById('dmError').classList.remove('show');
        }

        function dmLogin(e) {
            e.preventDefault();
            const user = document.getElementById('dmUser').value;
            const pass = document.getElementById('dmPass').value;
            if (user === 'Wizard' && pass === 'Wizard') {
                isDM = true;
                closeDMModal();
                document.getElementById('dmPanel').classList.add('open');
            } else {
                document.getElementById('dmError').classList.add('show');
            }
        }

        function closeDM() {
            document.getElementById('dmPanel').classList.remove('open');
        }

        // Player
        function showPlayerLogin() {
            document.getElementById('playerModal').classList.add('active');
        }

        function closePlayerModal() {
            document.getElementById('playerModal').classList.remove('active');
        }

        function playerLogin(e) {
            e.preventDefault();
            currentPlayer = document.getElementById('playerName').value;
            document.getElementById('playerNameDisplay').textContent = currentPlayer;
            document.getElementById('playerBar').classList.add('show');
            document.getElementById('playerBtn').textContent = 'âœ“';
            closePlayerModal();
        }

        function playerLogout() {
            currentPlayer = null;
            playerTokens = [];
            document.getElementById('playerBar').classList.remove('show');
            document.getElementById('playerBtn').textContent = 'ğŸ‘¤';
        }

        function createPlayerToken() {
            if (!currentPlayer) { showPlayerLogin(); return; }
            const i = prompt('Emoji:', 'âš”ï¸') || 'âš”ï¸';
            const c = prompt('Color:', '#e74c3c') || '#e74c3c';
            const t = { id: Date.now(), color: c, icon: i };
            playerTokens.push(t);
            renderPlayerTokens();
        }

        function renderPlayerTokens() {
            document.getElementById('playerTokens').innerHTML = playerTokens.map(t => `
                <div class="token" draggable="true" style="background: ${t.color};" 
                     ondragstart="dragPlayerToken(event, ${t.id})">${t.icon}</div>
            `).join('');
        }

        function dragPlayerToken(e, id) {
            const t = playerTokens.find(x => x.id === id);
            e.dataTransfer.setData('text/plain', JSON.stringify({ type: 'player', token: t }));
        }

        // Save/Load
        function saveGame() {
            const data = { tokens, gridCells: {}, fog: fogCanvas.toDataURL(), zoom, panX, panY };
            for (let key in gridCells) {
                data.gridCells[key] = gridCells[key].toDataURL();
            }
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'fractured-sky-' + Date.now() + '.json';
            a.click();
        }

        function loadGame() {
            document.getElementById('fileLoad').click();
        }

        function handleLoad(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                const data = JSON.parse(ev.target.result);
                tokens = data.tokens || [];
                zoom = data.zoom || 1;
                panX = data.panX || 0;
                panY = data.panY || 0;
                
                gridCells = {};
                for (let key in data.gridCells) {
                    const img = new Image();
                    img.onload = () => {
                        const cellCanvas = document.createElement('canvas');
                        cellCanvas.width = CELL_SIZE;
                        cellCanvas.height = CELL_SIZE;
                        const cellCtx = cellCanvas.getContext('2d');
                        cellCtx.drawImage(img, 0, 0);
                        gridCells[key] = cellCanvas;
                        draw();
                    };
                    img.src = data.gridCells[key];
                }
                
                if (data.fog) {
                    const img = new Image();
                    img.onload = () => {
                        fogCtx.clearRect(0, 0, fogCanvas.width, fogCanvas.height);
                        fogCtx.drawImage(img, 0, 0, fogCanvas.width, fogCanvas.height);
                        draw();
                    };
                    img.src = data.fog;
                }
                
                document.getElementById('zoomSlider').value = zoom * 100;
                document.getElementById('zoomValue').textContent = Math.round(zoom * 100) + '%';
                draw();
            };
            reader.readAsText(file);
        }

        init();
    </script>
</body>
</html>
