<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Fractured Sky - Virtual Tabletop</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #0a0e1a;
            --bg-card: #151928;
            --bg-hover: #1f2537;
            --accent: #8b5cf6;
            --accent-secondary: #ec4899;
            --gold: #fbbf24;
            --text: #e5e7eb;
            --text-dim: #9ca3af;
            --border: rgba(139, 92, 246, 0.2);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
        }

        /* Header */
        .header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .title {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--gold), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
        }

        .btn {
            padding: 0.6rem 1.2rem;
            background: var(--bg-hover);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--accent);
            border-color: var(--accent);
            transform: translateY(-1px);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            border: none;
            color: white;
        }

        /* Main Layout */
        .container {
            display: flex;
            height: calc(100vh - 70px);
        }

        .main-area {
            flex: 1;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }

        .tabletop {
            flex: 1;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        }

        .tabletop-header {
            padding: 1rem 1.5rem;
            background: var(--bg-hover);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .session-name {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            background: linear-gradient(135deg, var(--gold), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .slider {
            width: 120px;
            height: 4px;
            background: var(--bg-dark);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
        }

        .canvas-container {
            flex: 1;
            position: relative;
            background: radial-gradient(circle at center, #1a1f2e 0%, var(--bg-dark) 100%);
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            cursor: grab;
        }

        canvas:active {
            cursor: grabbing;
        }

        /* DM Panel */
        .dm-panel {
            width: 400px;
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.3s;
        }

        .dm-panel.open {
            transform: translateX(0);
        }

        .dm-header {
            position: sticky;
            top: 0;
            background: var(--bg-hover);
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .dm-content {
            padding: 1rem;
        }

        .section {
            background: var(--bg-hover);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .section h3 {
            margin-bottom: 0.75rem;
            color: var(--gold);
            font-size: 1.1rem;
        }

        .tool-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin: 0.75rem 0;
        }

        .tool-btn {
            padding: 0.75rem;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .tool-btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent);
        }

        .tool-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .control-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin: 0.75rem 0;
        }

        .control-row label {
            min-width: 80px;
            font-size: 0.9rem;
            color: var(--text-dim);
        }

        input[type="color"] {
            width: 50px;
            height: 36px;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
        }

        .asset-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            padding: 0.5rem;
            background: var(--bg-dark);
            border-radius: 6px;
            margin: 0.5rem 0;
        }

        .asset-btn {
            aspect-ratio: 1;
            background: var(--bg-hover);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .asset-btn:hover {
            transform: scale(1.1);
            border-color: var(--accent);
        }

        #mapCanvas {
            width: 100%;
            height: 300px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: white;
            cursor: crosshair;
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .modal-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .modal-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-dim);
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.95rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            color: #ef4444;
            padding: 0.75rem;
            border-radius: 6px;
            margin: 1rem 0;
            display: none;
        }

        .error.show {
            display: block;
        }

        /* Player Bar */
        .player-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            padding: 0.75rem 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            transform: translateY(100%);
            transition: transform 0.3s;
            z-index: 50;
        }

        .player-bar.show {
            transform: translateY(0);
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-hover);
            border-radius: 8px;
        }

        .player-tokens {
            flex: 1;
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
        }

        .token {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border: 2px solid var(--border);
            cursor: move;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .token:hover {
            transform: scale(1.1);
            border-color: var(--accent);
        }

        .player-login-btn {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .player-login-btn:hover {
            transform: scale(1.1);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="title">‚ú® THE FRACTURED SKY</div>
        <div class="header-actions">
            <button class="btn" onclick="saveGame()">üíæ Save</button>
            <button class="btn" onclick="loadGame()">üìÇ Load</button>
            <button class="btn btn-primary" onclick="openDM()">üé≠ DM Controls</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Main Area -->
        <div class="main-area">
            <div class="tabletop">
                <div class="tabletop-header">
                    <div class="session-name" id="sessionName">The Fractured Sky</div>
                    <div class="zoom-controls">
                        <span style="color: var(--text-dim); font-size: 0.9rem;">Zoom:</span>
                        <input type="range" class="slider" id="zoomSlider" min="25" max="200" value="100" oninput="setZoom(this.value)">
                        <span id="zoomValue" style="min-width: 50px; font-size: 0.9rem;">100%</span>
                    </div>
                </div>
                <div class="canvas-container">
                    <canvas id="mainCanvas" width="1600" height="900"></canvas>
                </div>
            </div>
        </div>

        <!-- DM Panel -->
        <div class="dm-panel" id="dmPanel">
            <div class="dm-header">
                <h2>üé≠ Dungeon Master</h2>
                <button class="btn" onclick="closeDM()">‚úï</button>
            </div>
            <div class="dm-content">
                <!-- Import Maps -->
                <div class="section">
                    <h3>üì• Import Maps</h3>
                    <a href="https://inkarnate.com/maps/" target="_blank" class="btn btn-primary" style="width: 100%; text-decoration: none; display: block; text-align: center; margin-bottom: 0.5rem;">
                        üó∫Ô∏è Open Inkarnate
                    </a>
                    <a href="https://www.owlbear.rodeo/" target="_blank" class="btn btn-primary" style="width: 100%; text-decoration: none; display: block; text-align: center; margin-bottom: 0.75rem;">
                        üé≤ Open Owlbear Rodeo
                    </a>
                    <input type="file" id="mapUpload" accept="image/*" style="display: none;" onchange="uploadMap(event)">
                    <div class="btn-group">
                        <button class="btn" onclick="document.getElementById('mapUpload').click()" style="flex: 1;">üì§ Upload Map</button>
                        <button class="btn btn-primary" onclick="loadMapToTable()">Load to Table</button>
                    </div>
                </div>

                <!-- Map Builder -->
                <div class="section">
                    <h3>üó∫Ô∏è Map Builder</h3>
                    <div class="tool-grid">
                        <div class="tool-btn active" onclick="setTool('brush')" id="brushBtn">üñåÔ∏è<br>Brush</div>
                        <div class="tool-btn" onclick="setTool('fill')" id="fillBtn">ü™£<br>Fill</div>
                        <div class="tool-btn" onclick="setTool('eraser')" id="eraserBtn">üßπ<br>Erase</div>
                        <div class="tool-btn" onclick="setTool('stamp')" id="stampBtn">üè∞<br>Stamp</div>
                    </div>
                    <div class="control-row">
                        <label>Color:</label>
                        <input type="color" id="colorPicker" value="#4a7c59">
                    </div>
                    <div class="control-row">
                        <label>Size:</label>
                        <input type="range" class="slider" id="sizeSlider" min="1" max="50" value="10" oninput="setSize(this.value)" style="flex: 1;">
                        <span id="sizeValue">10px</span>
                    </div>
                    <details>
                        <summary style="cursor: pointer; color: var(--gold); margin: 0.5rem 0;">Assets (40+)</summary>
                        <div class="asset-grid">
                            <div class="asset-btn" onclick="setStamp('üå≤')">üå≤</div>
                            <div class="asset-btn" onclick="setStamp('üå≥')">üå≥</div>
                            <div class="asset-btn" onclick="setStamp('üèîÔ∏è')">üèîÔ∏è</div>
                            <div class="asset-btn" onclick="setStamp('üåä')">üåä</div>
                            <div class="asset-btn" onclick="setStamp('üè∞')">üè∞</div>
                            <div class="asset-btn" onclick="setStamp('üèØ')">üèØ</div>
                            <div class="asset-btn" onclick="setStamp('‚õ™')">‚õ™</div>
                            <div class="asset-btn" onclick="setStamp('üèòÔ∏è')">üèòÔ∏è</div>
                            <div class="asset-btn" onclick="setStamp('üõ§Ô∏è')">üõ§Ô∏è</div>
                            <div class="asset-btn" onclick="setStamp('üåâ')">üåâ</div>
                            <div class="asset-btn" onclick="setStamp('üîÆ')">üîÆ</div>
                            <div class="asset-btn" onclick="setStamp('‚öîÔ∏è')">‚öîÔ∏è</div>
                            <div class="asset-btn" onclick="setStamp('üõ°Ô∏è')">üõ°Ô∏è</div>
                            <div class="asset-btn" onclick="setStamp('üèπ')">üèπ</div>
                            <div class="asset-btn" onclick="setStamp('üíé')">üíé</div>
                            <div class="asset-btn" onclick="setStamp('üî•')">üî•</div>
                            <div class="asset-btn" onclick="setStamp('‚ö°')">‚ö°</div>
                            <div class="asset-btn" onclick="setStamp('üíÄ')">üíÄ</div>
                            <div class="asset-btn" onclick="setStamp('üêâ')">üêâ</div>
                            <div class="asset-btn" onclick="setStamp('ü¶Ö')">ü¶Ö</div>
                        </div>
                    </details>
                    <canvas id="mapCanvas" width="800" height="450"></canvas>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="loadMapToTable()">Load to Table</button>
                        <button class="btn" onclick="clearMap()">Clear</button>
                    </div>
                </div>

                <!-- Fog of War -->
                <div class="section">
                    <h3>üå´Ô∏è Fog of War</h3>
                    <div class="control-row">
                        <label>Brush Size:</label>
                        <input type="range" class="slider" id="fogSize" min="20" max="150" value="60" oninput="setFogSize(this.value)" style="flex: 1;">
                        <span id="fogSizeValue">60px</span>
                    </div>
                    <div class="control-row">
                        <label>
                            <input type="checkbox" id="revealMode" checked> Reveal (uncheck to hide)
                        </label>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="toggleFog()" id="fogBtn">Enable Fog</button>
                        <button class="btn" onclick="resetFog()">Reset</button>
                    </div>
                </div>

                <!-- Tokens -->
                <div class="section">
                    <h3>üé≤ Tokens</h3>
                    <details>
                        <summary style="cursor: pointer; color: var(--gold); margin: 0.5rem 0;">Quick Add (12)</summary>
                        <div class="asset-grid" style="grid-template-columns: repeat(4, 1fr);">
                            <div class="asset-btn" onclick="addToken('#e74c3c', '‚öîÔ∏è')" style="background: #e74c3c;">‚öîÔ∏è</div>
                            <div class="asset-btn" onclick="addToken('#3498db', 'üõ°Ô∏è')" style="background: #3498db;">üõ°Ô∏è</div>
                            <div class="asset-btn" onclick="addToken('#2ecc71', 'üèπ')" style="background: #2ecc71;">üèπ</div>
                            <div class="asset-btn" onclick="addToken('#9b59b6', 'üîÆ')" style="background: #9b59b6;">üîÆ</div>
                            <div class="asset-btn" onclick="addToken('#f39c12', 'üó°Ô∏è')" style="background: #f39c12;">üó°Ô∏è</div>
                            <div class="asset-btn" onclick="addToken('#1abc9c', 'ü™Ñ')" style="background: #1abc9c;">ü™Ñ</div>
                            <div class="asset-btn" onclick="addToken('#8b4513', 'üëπ')" style="background: #8b4513;">üëπ</div>
                            <div class="asset-btn" onclick="addToken('#2c3e50', 'üíÄ')" style="background: #2c3e50;">üíÄ</div>
                            <div class="asset-btn" onclick="addToken('#c0392b', 'üëø')" style="background: #c0392b;">üëø</div>
                            <div class="asset-btn" onclick="addToken('#27ae60', 'üêâ')" style="background: #27ae60;">üêâ</div>
                        </div>
                    </details>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="addCustomToken()">+ Custom</button>
                        <button class="btn" onclick="clearTokens()">Clear All</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- DM Login Modal -->
    <div class="modal" id="dmModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">üßô</div>
                <h2>Dungeon Master</h2>
            </div>
            <form onsubmit="dmLogin(event)">
                <div class="form-group">
                    <label>USERNAME</label>
                    <input type="text" id="dmUser" placeholder="Enter username" autocomplete="off" required>
                </div>
                <div class="form-group">
                    <label>PASSWORD</label>
                    <input type="password" id="dmPass" placeholder="Enter password" autocomplete="off" required>
                </div>
                <div class="error" id="dmError">Invalid credentials</div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">ENTER</button>
                <button type="button" class="btn" onclick="closeDMModal()" style="width: 100%; margin-top: 0.5rem;">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Player Login Modal -->
    <div class="modal" id="playerModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">üë§</div>
                <h2>Player Login</h2>
            </div>
            <form onsubmit="playerLogin(event)">
                <div class="form-group">
                    <label>CHARACTER NAME</label>
                    <input type="text" id="playerName" placeholder="Enter your name" autocomplete="off" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">JOIN GAME</button>
                <button type="button" class="btn" onclick="closePlayerModal()" style="width: 100%; margin-top: 0.5rem;">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Player Bar -->
    <div class="player-bar" id="playerBar">
        <div class="player-info">
            <div style="width: 36px; height: 36px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;" id="playerAvatar">üë§</div>
            <span id="playerNameDisplay">Guest</span>
        </div>
        <div class="player-tokens" id="playerTokens"></div>
        <div style="display: flex; gap: 0.5rem;">
            <input type="file" id="tokenUpload" accept="image/*" style="display: none;" onchange="uploadToken(event)">
            <button class="btn" onclick="document.getElementById('tokenUpload').click()">üì§ Import</button>
            <button class="btn" onclick="createPlayerToken()">+ New</button>
            <button class="btn" onclick="playerLogout()">Logout</button>
        </div>
    </div>

    <!-- Player Login Button -->
    <button class="player-login-btn" onclick="showPlayerLogin()" id="playerBtn">üë§</button>

    <!-- Hidden File Input -->
    <input type="file" id="fileLoad" accept=".json" style="display: none;" onchange="handleLoad(event)">

    <script>
        // State
        let isDM = false;
        let currentPlayer = null;
        let zoom = 1;
        let panX = 0;
        let panY = 0;
        let tokens = [];
        let tool = 'brush';
        let color = '#4a7c59';
        let size = 10;
        let stamp = 'üå≤';
        let fogSize = 60;
        let fogMode = false;
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let dragToken = null;
        let mapImage = null;
        let playerTokens = [];

        // Canvas
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const mapCanvas = document.getElementById('mapCanvas');
        const mapCtx = mapCanvas.getContext('2d');
        const fogCanvas = document.createElement('canvas');
        const fogCtx = fogCanvas.getContext('2d');
        fogCanvas.width = canvas.width;
        fogCanvas.height = canvas.height;

        // Initialize
        function init() {
            mapCtx.fillStyle = '#f5f5dc';
            mapCtx.fillRect(0, 0, mapCanvas.width, mapCanvas.height);
            fogCtx.fillStyle = 'rgba(0,0,0,0.9)';
            fogCtx.fillRect(0, 0, fogCanvas.width, fogCanvas.height);
            
            // Center view
            const container = canvas.parentElement;
            panX = (container.offsetWidth - canvas.width) / 2;
            panY = (container.offsetHeight - canvas.height) / 2;
            
            draw();
        }

        // Draw
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(panX, panY);
            ctx.scale(zoom, zoom);

            // Background
            if (mapImage) {
                ctx.drawImage(mapImage, 0, 0, canvas.width, canvas.height);
            } else {
                ctx.fillStyle = '#1a1f2e';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                // Grid
                ctx.strokeStyle = '#2a2f3e';
                ctx.lineWidth = 1;
                for (let x = 0; x < canvas.width; x += 50) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvas.height);
                    ctx.stroke();
                }
                for (let y = 0; y < canvas.height; y += 50) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(canvas.width, y);
                    ctx.stroke();
                }
            }

            // Tokens
            tokens.forEach(t => {
                ctx.fillStyle = t.color;
                ctx.beginPath();
                ctx.arc(t.x, t.y, 30, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = t.owner ? '#8b5cf6' : '#fbbf24';
                ctx.lineWidth = 3;
                ctx.stroke();
                ctx.fillStyle = '#fff';
                ctx.font = '32px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(t.icon, t.x, t.y);
                if (t.owner && currentPlayer && t.owner === currentPlayer) {
                    ctx.fillStyle = '#8b5cf6';
                    ctx.font = '12px Inter';
                    ctx.fillText(t.owner, t.x, t.y + 45);
                }
            });

            ctx.restore();

            // Fog
            ctx.save();
            ctx.translate(panX, panY);
            ctx.scale(zoom, zoom);
            ctx.drawImage(fogCanvas, 0, 0);
            ctx.restore();
        }

        // DM Functions
        function openDM() {
            document.getElementById('dmModal').classList.add('active');
        }

        function closeDMModal() {
            document.getElementById('dmModal').classList.remove('active');
            document.getElementById('dmError').classList.remove('show');
        }

        function dmLogin(e) {
            e.preventDefault();
            const user = document.getElementById('dmUser').value;
            const pass = document.getElementById('dmPass').value;
            if (user === 'Wizard' && pass === 'Wizard') {
                isDM = true;
                closeDMModal();
                document.getElementById('dmPanel').classList.add('open');
            } else {
                document.getElementById('dmError').classList.add('show');
            }
        }

        function closeDM() {
            document.getElementById('dmPanel').classList.remove('open');
        }

        // Map Tools
        function setTool(t) {
            tool = t;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(t + 'Btn').classList.add('active');
        }

        function setSize(v) {
            size = v;
            document.getElementById('sizeValue').textContent = v + 'px';
        }

        function setStamp(s) {
            stamp = s;
            setTool('stamp');
        }

        document.getElementById('colorPicker').addEventListener('change', e => {
            color = e.target.value;
        });

        // Map Canvas Drawing
        mapCanvas.addEventListener('mousedown', e => {
            isDrawing = true;
            const rect = mapCanvas.getBoundingClientRect();
            const scaleX = mapCanvas.width / rect.width;
            const scaleY = mapCanvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            lastX = x;
            lastY = y;

            if (tool === 'brush') {
                mapCtx.beginPath();
                mapCtx.moveTo(x, y);
                mapCtx.strokeStyle = color;
                mapCtx.lineWidth = size;
                mapCtx.lineCap = 'round';
            } else if (tool === 'fill') {
                mapCtx.fillStyle = color;
                mapCtx.fillRect(0, 0, mapCanvas.width, mapCanvas.height);
            } else if (tool === 'stamp') {
                mapCtx.font = '48px Arial';
                mapCtx.fillText(stamp, x - 24, y + 12);
            } else if (tool === 'eraser') {
                mapCtx.globalCompositeOperation = 'destination-out';
                mapCtx.beginPath();
                mapCtx.moveTo(x, y);
                mapCtx.lineWidth = size;
            }
        });

        mapCanvas.addEventListener('mousemove', e => {
            if (!isDrawing) return;
            const rect = mapCanvas.getBoundingClientRect();
            const scaleX = mapCanvas.width / rect.width;
            const scaleY = mapCanvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            if (tool === 'brush') {
                mapCtx.lineTo(x, y);
                mapCtx.stroke();
            } else if (tool === 'eraser') {
                mapCtx.lineTo(x, y);
                mapCtx.stroke();
            }
        });

        mapCanvas.addEventListener('mouseup', () => {
            isDrawing = false;
            if (tool === 'eraser') {
                mapCtx.globalCompositeOperation = 'source-over';
            }
        });

        function clearMap() {
            if (confirm('Clear map?')) {
                mapCtx.fillStyle = '#f5f5dc';
                mapCtx.fillRect(0, 0, mapCanvas.width, mapCanvas.height);
            }
        }

        function uploadMap(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                const img = new Image();
                img.onload = () => {
                    mapCtx.fillStyle = '#f5f5dc';
                    mapCtx.fillRect(0, 0, mapCanvas.width, mapCanvas.height);
                    mapCtx.drawImage(img, 0, 0, mapCanvas.width, mapCanvas.height);
                    alert('Map uploaded! Click "Load to Table"');
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        }

        function loadMapToTable() {
            const img = new Image();
            img.onload = () => {
                mapImage = img;
                draw();
            };
            img.src = mapCanvas.toDataURL();
        }

        // Fog
        function setFogSize(v) {
            fogSize = v;
            document.getElementById('fogSizeValue').textContent = v + 'px';
        }

        function toggleFog() {
            fogMode = !fogMode;
            const btn = document.getElementById('fogBtn');
            if (fogMode) {
                btn.textContent = 'Fog Active';
                btn.classList.add('btn-primary');
                canvas.style.cursor = 'crosshair';
            } else {
                btn.textContent = 'Enable Fog';
                btn.classList.remove('btn-primary');
                canvas.style.cursor = 'grab';
            }
        }

        function resetFog() {
            fogCtx.fillStyle = 'rgba(0,0,0,0.9)';
            fogCtx.fillRect(0, 0, fogCanvas.width, fogCanvas.height);
            draw();
        }

        // Tokens
        function addToken(c, i) {
            tokens.push({ x: canvas.width / 2, y: canvas.height / 2, color: c, icon: i, owner: null });
            draw();
        }

        function addCustomToken() {
            const i = prompt('Emoji:', '‚öîÔ∏è') || '‚öîÔ∏è';
            const c = prompt('Color:', '#e74c3c') || '#e74c3c';
            addToken(c, i);
        }

        function clearTokens() {
            if (confirm('Clear all tokens?')) {
                tokens = [];
                draw();
            }
        }

        // Zoom/Pan
        function setZoom(v) {
            zoom = v / 100;
            document.getElementById('zoomValue').textContent = Math.round(v) + '%';
            draw();
        }

        // Canvas Interaction
        canvas.addEventListener('mousedown', e => {
            const rect = canvas.getBoundingClientRect();
            const mx = (e.clientX - rect.left - panX) / zoom;
            const my = (e.clientY - rect.top - panY) / zoom;

            if (fogMode) {
                isDrawing = true;
                applyFog(mx, my);
                return;
            }

            dragToken = tokens.find(t => {
                const dx = mx - t.x;
                const dy = my - t.y;
                const near = Math.sqrt(dx*dx + dy*dy) < 30;
                if (currentPlayer && t.owner) return near && t.owner === currentPlayer;
                return near && (!t.owner || isDM);
            });

            if (dragToken) {
                isDrawing = true;
            } else {
                lastX = e.clientX;
                lastY = e.clientY;
                isDrawing = true;
            }
        });

        canvas.addEventListener('mousemove', e => {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            const mx = (e.clientX - rect.left - panX) / zoom;
            const my = (e.clientY - rect.top - panY) / zoom;

            if (fogMode) {
                applyFog(mx, my);
                return;
            }

            if (dragToken) {
                dragToken.x = mx;
                dragToken.y = my;
                draw();
            } else {
                panX += e.clientX - lastX;
                panY += e.clientY - lastY;
                lastX = e.clientX;
                lastY = e.clientY;
                draw();
            }
        });

        canvas.addEventListener('mouseup', () => {
            isDrawing = false;
            dragToken = null;
        });

        function applyFog(x, y) {
            const reveal = document.getElementById('revealMode').checked;
            if (reveal) {
                fogCtx.globalCompositeOperation = 'destination-out';
            } else {
                fogCtx.globalCompositeOperation = 'source-over';
                fogCtx.fillStyle = 'rgba(0,0,0,0.9)';
            }
            fogCtx.beginPath();
            fogCtx.arc(x, y, fogSize, 0, Math.PI * 2);
            fogCtx.fill();
            draw();
        }

        // Player
        function showPlayerLogin() {
            document.getElementById('playerModal').classList.add('active');
        }

        function closePlayerModal() {
            document.getElementById('playerModal').classList.remove('active');
        }

        function playerLogin(e) {
            e.preventDefault();
            currentPlayer = document.getElementById('playerName').value;
            document.getElementById('playerNameDisplay').textContent = currentPlayer;
            document.getElementById('playerBar').classList.add('show');
            document.getElementById('playerBtn').textContent = '‚úì';
            closePlayerModal();
        }

        function playerLogout() {
            currentPlayer = null;
            playerTokens = [];
            document.getElementById('playerBar').classList.remove('show');
            document.getElementById('playerBtn').textContent = 'üë§';
        }

        function createPlayerToken() {
            if (!currentPlayer) { showPlayerLogin(); return; }
            const i = prompt('Emoji:', '‚öîÔ∏è') || '‚öîÔ∏è';
            const c = prompt('Color:', '#e74c3c') || '#e74c3c';
            const t = { id: Date.now(), color: c, icon: i };
            playerTokens.push(t);
            renderPlayerTokens();
        }

        function renderPlayerTokens() {
            document.getElementById('playerTokens').innerHTML = playerTokens.map(t => `
                <div class="token" draggable="true" style="background: ${t.color};" 
                     ondragstart="dragPlayerToken(event, ${t.id})">${t.icon}</div>
            `).join('');
        }

        function dragPlayerToken(e, id) {
            const t = playerTokens.find(x => x.id === id);
            e.dataTransfer.setData('text/plain', JSON.stringify({ type: 'player', token: t }));
        }

        canvas.addEventListener('dragover', e => e.preventDefault());
        canvas.addEventListener('drop', e => {
            e.preventDefault();
            try {
                const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                if (data.type === 'player') {
                    const rect = canvas.getBoundingClientRect();
                    const x = (e.clientX - rect.left - panX) / zoom;
                    const y = (e.clientY - rect.top - panY) / zoom;
                    tokens.push({ x, y, color: data.token.color, icon: data.token.icon, owner: currentPlayer });
                    draw();
                }
            } catch {}
        });

        function uploadToken(e) {
            if (!currentPlayer) { showPlayerLogin(); return; }
            // For now, just use emoji
            createPlayerToken();
        }

        // Save/Load
        function saveGame() {
            const data = {
                tokens,
                map: mapImage ? mapImage.src : null,
                fog: fogCanvas.toDataURL(),
                zoom,
                panX,
                panY
            };
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'fractured-sky-' + Date.now() + '.json';
            a.click();
        }

        function loadGame() {
            document.getElementById('fileLoad').click();
        }

        function handleLoad(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                const data = JSON.parse(ev.target.result);
                tokens = data.tokens || [];
                zoom = data.zoom || 1;
                panX = data.panX || 0;
                panY = data.panY || 0;
                document.getElementById('zoomSlider').value = zoom * 100;
                document.getElementById('zoomValue').textContent = Math.round(zoom * 100) + '%';
                
                if (data.map) {
                    const img = new Image();
                    img.onload = () => {
                        mapImage = img;
                        draw();
                    };
                    img.src = data.map;
                }
                
                if (data.fog) {
                    const img = new Image();
                    img.onload = () => {
                        fogCtx.clearRect(0, 0, fogCanvas.width, fogCanvas.height);
                        fogCtx.drawImage(img, 0, 0);
                        draw();
                    };
                    img.src = data.fog;
                }
                
                draw();
            };
            reader.readAsText(file);
        }

        // Init
        init();
    </script>
</body>
</html>
