<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mystic Tabletop - Virtual TTRPG</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Raleway:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #1f2937;
            --accent-primary: #8b5cf6;
            --accent-secondary: #ec4899;
            --accent-gold: #fbbf24;
            --text-primary: #f3f4f6;
            --text-secondary: #9ca3af;
            --border-subtle: rgba(139, 92, 246, 0.1);
            --border-focus: rgba(139, 92, 246, 0.3);
            --shadow-glow: 0 0 30px rgba(139, 92, 246, 0.15);
            --shadow-deep: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        body {
            font-family: 'Raleway', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        /* Refined Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 10% 20%, rgba(139, 92, 246, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(236, 72, 153, 0.06) 0%, transparent 40%);
            pointer-events: none;
            z-index: -1;
        }

        /* Navigation */
        .nav-bar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-subtle);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1.5rem;
            box-shadow: var(--shadow-deep);
            position: relative;
            z-index: 100;
        }

        .logo {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-center {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .tab-container {
            display: flex;
            gap: 0.5rem;
            flex: 1;
            overflow-x: auto;
            padding: 0.25rem 0;
        }

        .tab-container::-webkit-scrollbar {
            height: 4px;
        }

        .tab-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .tab-container::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 2px;
        }

        .tab {
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
        }

        .tab:hover {
            background: var(--bg-primary);
            border-color: var(--border-focus);
            color: var(--text-primary);
        }

        .tab.active {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(236, 72, 153, 0.2) 100%);
            border-color: var(--accent-primary);
            color: var(--text-primary);
            box-shadow: var(--shadow-glow);
        }

        .tab-close {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-secondary);
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .tab-close:hover {
            background: var(--accent-secondary);
            color: white;
        }

        .add-tab-btn {
            padding: 0.5rem 1rem;
            background: transparent;
            border: 1px dashed var(--border-focus);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .add-tab-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .nav-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
            box-shadow: var(--shadow-glow);
        }

        .dm-btn {
            padding: 0.5rem 1.25rem;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 0.875rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .dm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
        }

        /* Main Container */
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
        }

        /* Player View */
        .player-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            position: relative;
        }

        /* Atmospheric particles */
        .player-view::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(139, 92, 246, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(236, 72, 153, 0.03) 0%, transparent 50%);
            pointer-events: none;
            animation: ambientPulse 8s ease-in-out infinite;
        }

        @keyframes ambientPulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .tabletop-wrapper {
            flex: 1;
            background: linear-gradient(135deg, rgba(22, 27, 34, 0.95) 0%, rgba(13, 17, 23, 0.98) 100%);
            border-radius: 16px;
            border: 1px solid var(--border-focus);
            overflow: hidden;
            box-shadow: 
                var(--shadow-deep),
                0 0 60px rgba(139, 92, 246, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .tabletop-wrapper::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: linear-gradient(180deg, 
                rgba(139, 92, 246, 0.08) 0%, 
                transparent 100%);
            pointer-events: none;
            z-index: 1;
        }

        .tabletop-controls {
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, 
                rgba(31, 41, 55, 0.8) 0%, 
                rgba(22, 27, 34, 0.9) 100%);
            border-bottom: 1px solid var(--border-focus);
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 2;
        }

        .session-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-primary) 50%, var(--accent-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 1px;
            text-shadow: 0 0 30px rgba(251, 191, 36, 0.3);
            position: relative;
        }

        .session-title::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                var(--accent-gold) 50%, 
                transparent 100%);
            opacity: 0.5;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .control-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .slider {
            -webkit-appearance: none;
            appearance: none;
            width: 120px;
            height: 4px;
            background: var(--bg-primary);
            border-radius: 2px;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            background: var(--accent-primary);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }

        .slider::-webkit-slider-thumb:hover {
            width: 16px;
            height: 16px;
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
        }

        .canvas-area {
            flex: 1;
            position: relative;
            background: 
                radial-gradient(circle at center, rgba(22, 27, 34, 0.7) 0%, rgba(13, 17, 23, 1) 100%),
                linear-gradient(135deg, rgba(139, 92, 246, 0.02) 0%, rgba(236, 72, 153, 0.02) 100%);
            overflow: hidden;
        }

        .canvas-area::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            right: -50%;
            bottom: -50%;
            background: 
                radial-gradient(circle at 30% 40%, rgba(139, 92, 246, 0.08) 0%, transparent 30%),
                radial-gradient(circle at 70% 60%, rgba(236, 72, 153, 0.06) 0%, transparent 30%);
            animation: slowRotate 60s linear infinite;
            pointer-events: none;
        }

        @keyframes slowRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .canvas-area::after {
            content: '';
            position: absolute;
            inset: 0;
            background: 
                linear-gradient(to bottom, 
                    transparent 0%, 
                    rgba(251, 191, 36, 0.03) 50%, 
                    transparent 100%);
            pointer-events: none;
            animation: ambientSweep 10s ease-in-out infinite;
        }

        @keyframes ambientSweep {
            0%, 100% { opacity: 0.3; transform: translateY(0); }
            50% { opacity: 0.6; transform: translateY(-20px); }
        }

        #tabletopCanvas {
            width: 100%;
            height: 100%;
            cursor: grab;
        }

        #tabletopCanvas:active {
            cursor: grabbing;
        }

        /* DM Panel */
        .dm-panel {
            width: 420px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-subtle);
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: -5px 0 30px rgba(0, 0, 0, 0.3);
        }

        .dm-panel.open {
            transform: translateX(0);
        }

        .dm-header {
            position: sticky;
            top: 0;
            background: var(--bg-tertiary);
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            backdrop-filter: blur(10px);
        }

        .dm-header h2 {
            font-family: 'Playfair Display', serif;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--accent-primary);
        }

        .close-btn {
            width: 30px;
            height: 30px;
            background: transparent;
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: var(--accent-secondary);
            border-color: var(--accent-secondary);
            color: white;
        }

        .dm-content {
            padding: 1.25rem;
        }

        .section {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .section-header {
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent-gold);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Tool Grid */
        .tool-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .tool-card {
            aspect-ratio: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .tool-card:hover {
            background: var(--bg-primary);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .tool-card.active {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(236, 72, 153, 0.2) 100%);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            box-shadow: var(--shadow-glow);
        }

        .tool-icon {
            font-size: 1.5rem;
        }

        /* Asset Picker */
        .asset-picker {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
            max-height: 250px;
            overflow-y: auto;
            padding: 0.5rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin: 0.75rem 0;
        }

        .asset-btn {
            aspect-ratio: 1;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            font-size: 1.75rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .asset-btn:hover {
            background: var(--bg-primary);
            border-color: var(--accent-primary);
            transform: scale(1.1);
        }

        .asset-btn.active {
            border-color: var(--accent-primary);
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.3);
        }

        /* Canvas */
        #mapCanvas {
            width: 100%;
            height: 300px;
            border-radius: 8px;
            border: 1px solid var(--border-subtle);
            background: white;
            cursor: crosshair;
        }

        /* Controls */
        .control-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin: 0.75rem 0;
        }

        .control-row label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            min-width: 80px;
            font-weight: 500;
        }

        .control-row input[type="color"] {
            width: 50px;
            height: 36px;
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            cursor: pointer;
            background: transparent;
        }

        .control-row .slider {
            flex: 1;
        }

        .control-row span {
            font-size: 0.875rem;
            color: var(--text-secondary);
            min-width: 45px;
            text-align: right;
        }

        /* Buttons */
        .btn {
            padding: 0.65rem 1.25rem;
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            border: none;
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .btn-success {
            background: #10b981;
            border: none;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #ef4444;
            border: none;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Info Box */
        .info-box {
            background: rgba(139, 92, 246, 0.05);
            border: 1px solid var(--border-focus);
            border-radius: 8px;
            padding: 0.75rem;
            margin: 0.75rem 0;
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Checkbox */
        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.65rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .checkbox-row:hover {
            background: var(--bg-primary);
            border-color: var(--border-focus);
        }

        .checkbox-row input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* Login Modal */
        .login-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .login-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .login-modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-focus);
            border-radius: 16px;
            padding: 2.5rem;
            max-width: 400px;
            width: 90%;
            box-shadow: var(--shadow-deep), var(--shadow-glow);
            transform: scale(0.95);
            transition: transform 0.3s;
        }

        .login-overlay.active .login-modal {
            transform: scale(1);
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-icon {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .login-header h2 {
            font-family: 'Playfair Display', serif;
            font-size: 1.75rem;
            color: var(--accent-primary);
            margin-bottom: 0.5rem;
        }

        .login-header p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            letter-spacing: 0.5px;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            color: #ef4444;
            padding: 0.75rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.875rem;
            text-align: center;
            display: none;
        }

        .error-message.show {
            display: block;
            animation: shake 0.4s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-secondary);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .dm-panel {
                width: 100%;
                position: fixed;
                top: 60px;
                right: 0;
                height: calc(100vh - 60px);
                z-index: 200;
            }

            .nav-center {
                display: none;
            }
        }

        /* Player Token Bar */
        .player-token-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, rgba(22, 27, 34, 0.95) 0%, rgba(13, 17, 23, 0.98) 100%);
            border-top: 1px solid var(--border-focus);
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            z-index: 90;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .player-token-bar.show {
            transform: translateY(0);
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid var(--border-focus);
            border-radius: 8px;
        }

        .player-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            border: 2px solid var(--accent-primary);
        }

        .player-name {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .my-tokens {
            flex: 1;
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding: 0.25rem 0;
        }

        .my-tokens::-webkit-scrollbar {
            height: 4px;
        }

        .player-token {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border: 2px solid var(--border-subtle);
            cursor: move;
            transition: all 0.2s;
            flex-shrink: 0;
            position: relative;
        }

        .player-token:hover {
            transform: scale(1.1);
            border-color: var(--accent-primary);
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.5);
        }

        .player-token.selected {
            border-color: var(--accent-gold);
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.6);
        }

        .token-controls {
            display: flex;
            gap: 0.5rem;
        }

        .mini-btn {
            padding: 0.5rem 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .mini-btn:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        /* Player Login Modal */
        .player-login-btn {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
            transition: all 0.3s;
            z-index: 95;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .player-login-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(139, 92, 246, 0.6);
        }

        .player-login-btn.logged-in {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav-bar">
        <div class="logo">
            <span>‚ú®</span>
            <span>MYSTIC TABLETOP</span>
        </div>

        <div class="nav-center">
            <div class="tab-container" id="tabContainer">
                <!-- Tabs will be inserted here -->
            </div>
            <button class="add-tab-btn" onclick="createNewSession()">+ New Session</button>
        </div>

        <div class="nav-actions">
            <button class="icon-btn" onclick="saveSession()" title="Save Session">üíæ</button>
            <button class="icon-btn" onclick="loadSession()" title="Load Session">üìÇ</button>
            <button class="dm-btn" onclick="showLogin()">üé≠ DM Controls</button>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Player View -->
        <div class="player-view">
            <div class="tabletop-wrapper">
                <div class="tabletop-controls">
                    <div class="control-group">
                        <span class="session-title" id="sessionName">The Fractured Sky</span>
                    </div>
                    <div class="control-group">
                        <span class="control-label">Zoom:</span>
                        <input type="range" class="slider" id="zoomSlider" min="50" max="300" value="100" oninput="updateZoom(this.value)">
                        <span id="zoomValue">100%</span>
                    </div>
                </div>
                <div class="canvas-area">
                    <canvas id="tabletopCanvas" width="1600" height="900"></canvas>
                </div>
            </div>
        </div>

        <!-- DM Panel -->
        <div class="dm-panel" id="dmPanel">
            <div class="dm-header">
                <h2>üé≠ Dungeon Master</h2>
                <button class="close-btn" onclick="closeDMPanel()">√ó</button>
            </div>

            <div class="dm-content">
                <!-- Import Maps -->
                <div class="section">
                    <div class="section-header">üì• Import Maps</div>

                    <div class="info-box">
                        Import maps from professional tools or upload your own images
                    </div>

                    <div style="display: grid; gap: 0.75rem; margin: 1rem 0;">
                        <a href="https://inkarnate.com/maps/" target="_blank" class="btn btn-primary" style="text-decoration: none; justify-content: center;">
                            üó∫Ô∏è Open Inkarnate
                        </a>
                        <a href="https://www.owlbear.rodeo/" target="_blank" class="btn btn-primary" style="text-decoration: none; justify-content: center;">
                            üé≤ Open Owlbear Rodeo
                        </a>
                    </div>

                    <div class="info-box" style="font-size: 0.8rem; line-height: 1.5;">
                        <strong>How to import:</strong><br>
                        1. Create/export map from Inkarnate or Owlbear<br>
                        2. Click "Upload Image" below<br>
                        3. Select your downloaded map file<br>
                        4. Click "Load to Table" to display
                    </div>

                    <input type="file" id="mapUpload" accept="image/*" style="display: none;" onchange="handleMapUpload(event)">
                    
                    <div class="btn-group" style="margin-top: 1rem;">
                        <button class="btn btn-success" onclick="document.getElementById('mapUpload').click()" style="flex: 1;">
                            üì§ Upload Image
                        </button>
                        <button class="btn btn-primary" onclick="loadMapToTable()">
                            üì• Load to Table
                        </button>
                    </div>
                </div>

                <!-- Map Builder -->
                <div class="section">
                    <div class="section-header">üó∫Ô∏è Map Builder</div>

                    <div class="tool-grid">
                        <div class="tool-card active" onclick="setTool('brush')" id="brushTool">
                            <div class="tool-icon">üñåÔ∏è</div>
                            <div>Brush</div>
                        </div>
                        <div class="tool-card" onclick="setTool('fill')" id="fillTool">
                            <div class="tool-icon">ü™£</div>
                            <div>Fill</div>
                        </div>
                        <div class="tool-card" onclick="setTool('eraser')" id="eraserTool">
                            <div class="tool-icon">üßπ</div>
                            <div>Erase</div>
                        </div>
                        <div class="tool-card" onclick="setTool('stamp')" id="stampTool">
                            <div class="tool-icon">üè∞</div>
                            <div>Stamp</div>
                        </div>
                        <div class="tool-card" onclick="setTool('line')" id="lineTool">
                            <div class="tool-icon">üìè</div>
                            <div>Line</div>
                        </div>
                        <div class="tool-card" onclick="setTool('rect')" id="rectTool">
                            <div class="tool-icon">‚¨ú</div>
                            <div>Rect</div>
                        </div>
                        <div class="tool-card" onclick="setTool('circle')" id="circleTool">
                            <div class="tool-icon">‚≠ï</div>
                            <div>Circle</div>
                        </div>
                        <div class="tool-card" onclick="setTool('text')" id="textTool">
                            <div class="tool-icon">üìù</div>
                            <div>Text</div>
                        </div>
                    </div>

                    <div class="control-row">
                        <label>Color:</label>
                        <input type="color" id="colorPicker" value="#4a7c59">
                    </div>

                    <div class="control-row">
                        <label>Size:</label>
                        <input type="range" class="slider" id="brushSize" min="1" max="100" value="15" oninput="updateBrushSize(this.value)">
                        <span id="brushSizeValue">15px</span>
                    </div>

                    <details style="margin: 1rem 0;">
                        <summary style="cursor: pointer; color: var(--accent-gold); font-weight: 500; margin-bottom: 0.5rem;">Assets Library (70+)</summary>
                        <div class="asset-picker">
                            <div class="asset-btn" onclick="selectStamp('üå≤')">üå≤</div>
                            <div class="asset-btn" onclick="selectStamp('üå≥')">üå≥</div>
                            <div class="asset-btn" onclick="selectStamp('üå¥')">üå¥</div>
                            <div class="asset-btn" onclick="selectStamp('üçÉ')">üçÉ</div>
                            <div class="asset-btn" onclick="selectStamp('üåø')">üåø</div>
                            <div class="asset-btn" onclick="selectStamp('üèîÔ∏è')">üèîÔ∏è</div>
                            <div class="asset-btn" onclick="selectStamp('‚õ∞Ô∏è')">‚õ∞Ô∏è</div>
                            <div class="asset-btn" onclick="selectStamp('üóª')">üóª</div>
                            <div class="asset-btn" onclick="selectStamp('üåä')">üåä</div>
                            <div class="asset-btn" onclick="selectStamp('üíß')">üíß</div>
                            <div class="asset-btn" onclick="selectStamp('üè∞')">üè∞</div>
                            <div class="asset-btn" onclick="selectStamp('üèØ')">üèØ</div>
                            <div class="asset-btn" onclick="selectStamp('üèõÔ∏è')">üèõÔ∏è</div>
                            <div class="asset-btn" onclick="selectStamp('‚õ™')">‚õ™</div>
                            <div class="asset-btn" onclick="selectStamp('üèòÔ∏è')">üèòÔ∏è</div>
                            <div class="asset-btn" onclick="selectStamp('üèöÔ∏è')">üèöÔ∏è</div>
                            <div class="asset-btn" onclick="selectStamp('üè†')">üè†</div>
                            <div class="asset-btn" onclick="selectStamp('‚õ∫')">‚õ∫</div>
                            <div class="asset-btn" onclick="selectStamp('üõ§Ô∏è')">üõ§Ô∏è</div>
                            <div class="asset-btn" onclick="selectStamp('üåâ')">üåâ</div>
                            <div class="asset-btn" onclick="selectStamp('üîÆ')">üîÆ</div>
                            <div class="asset-btn" onclick="selectStamp('‚öóÔ∏è')">‚öóÔ∏è</div>
                            <div class="asset-btn" onclick="selectStamp('üìú')">üìú</div>
                            <div class="asset-btn" onclick="selectStamp('‚öîÔ∏è')">‚öîÔ∏è</div>
                            <div class="asset-btn" onclick="selectStamp('üó°Ô∏è')">üó°Ô∏è</div>
                            <div class="asset-btn" onclick="selectStamp('üõ°Ô∏è')">üõ°Ô∏è</div>
                            <div class="asset-btn" onclick="selectStamp('üèπ')">üèπ</div>
                            <div class="asset-btn" onclick="selectStamp('ü™ì')">ü™ì</div>
                            <div class="asset-btn" onclick="selectStamp('üíé')">üíé</div>
                            <div class="asset-btn" onclick="selectStamp('üëë')">üëë</div>
                            <div class="asset-btn" onclick="selectStamp('üî•')">üî•</div>
                            <div class="asset-btn" onclick="selectStamp('‚ùÑÔ∏è')">‚ùÑÔ∏è</div>
                            <div class="asset-btn" onclick="selectStamp('‚ö°')">‚ö°</div>
                            <div class="asset-btn" onclick="selectStamp('üíÄ')">üíÄ</div>
                            <div class="asset-btn" onclick="selectStamp('üïØÔ∏è')">üïØÔ∏è</div>
                            <div class="asset-btn" onclick="selectStamp('üêâ')">üêâ</div>
                            <div class="asset-btn" onclick="selectStamp('ü¶Ö')">ü¶Ö</div>
                            <div class="asset-btn" onclick="selectStamp('ü¶â')">ü¶â</div>
                            <div class="asset-btn" onclick="selectStamp('ü¶á')">ü¶á</div>
                            <div class="asset-btn" onclick="selectStamp('üê∫')">üê∫</div>
                            <div class="asset-btn" onclick="selectStamp('ü¶Å')">ü¶Å</div>
                            <div class="asset-btn" onclick="selectStamp('üêª')">üêª</div>
                            <div class="asset-btn" onclick="selectStamp('ü¶å')">ü¶å</div>
                            <div class="asset-btn" onclick="selectStamp('üçÑ')">üçÑ</div>
                            <div class="asset-btn" onclick="selectStamp('ü™®')">ü™®</div>
                        </div>
                    </details>

                    <canvas id="mapCanvas" width="1600" height="900"></canvas>

                    <div class="btn-group" style="margin-top: 1rem;">
                        <button class="btn btn-primary" onclick="loadMapToTable()">üì• Load to Table</button>
                        <button class="btn" onclick="exportMap()">üíæ Export</button>
                        <button class="btn btn-danger" onclick="clearMap()">üóëÔ∏è Clear</button>
                    </div>
                </div>

                <!-- Fog of War -->
                <div class="section">
                    <div class="section-header">üå´Ô∏è Fog of War</div>

                    <div class="info-box">
                        Enable fog mode to reveal/hide areas. Perfect for exploration!</div>

                    <div class="control-row">
                        <label>Brush:</label>
                        <input type="range" class="slider" id="fogBrushSize" min="20" max="200" value="60" oninput="updateFogBrush(this.value)">
                        <span id="fogBrushValue">60px</span>
                    </div>

                    <label class="checkbox-row">
                        <input type="checkbox" id="revealMode" checked onchange="updateFogMode()">
                        <span>Reveal Mode (uncheck to hide)</span>
                    </label>

                    <div class="btn-group" style="margin-top: 1rem;">
                        <button class="btn btn-primary" onclick="toggleFogMode()" id="fogModeBtn">Enable Fog</button>
                        <button class="btn btn-danger" onclick="resetFog()">Reset Fog</button>
                    </div>
                </div>

                <!-- Tokens -->
                <div class="section">
                    <div class="section-header">üé≤ Tokens</div>

                    <details style="margin: 0.5rem 0;">
                        <summary style="cursor: pointer; color: var(--accent-gold); font-weight: 500; margin-bottom: 0.5rem;">Quick Add (16 Tokens)</summary>
                        <div class="asset-picker" style="grid-template-columns: repeat(4, 1fr);">
                            <div class="asset-btn" onclick="addTokenWithIcon('#e74c3c', '‚öîÔ∏è')" style="background: #e74c3c;">‚öîÔ∏è</div>
                            <div class="asset-btn" onclick="addTokenWithIcon('#3498db', 'üõ°Ô∏è')" style="background: #3498db;">üõ°Ô∏è</div>
                            <div class="asset-btn" onclick="addTokenWithIcon('#2ecc71', 'üèπ')" style="background: #2ecc71;">üèπ</div>
                            <div class="asset-btn" onclick="addTokenWithIcon('#9b59b6', 'üîÆ')" style="background: #9b59b6;">üîÆ</div>
                            <div class="asset-btn" onclick="addTokenWithIcon('#f39c12', 'üó°Ô∏è')" style="background: #f39c12;">üó°Ô∏è</div>
                            <div class="asset-btn" onclick="addTokenWithIcon('#1abc9c', 'ü™Ñ')" style="background: #1abc9c;">ü™Ñ</div>
                            <div class="asset-btn" onclick="addTokenWithIcon('#e67e22', 'ü¶Å')" style="background: #e67e22;">ü¶Å</div>
                            <div class="asset-btn" onclick="addTokenWithIcon('#34495e', 'üéµ')" style="background: #34495e;">üéµ</div>
                            <div class="asset-btn" onclick="addTokenWithIcon('#8b4513', 'üëπ')" style="background: #8b4513;">üëπ</div>
                            <div class="asset-btn" onclick="addTokenWithIcon('#2c3e50', 'üíÄ')" style="background: #2c3e50;">üíÄ</div>
                            <div class="asset-btn" onclick="addTokenWithIcon('#c0392b', 'üëø')" style="background: #c0392b;">üëø</div>
                            <div class="asset-btn" onclick="addTokenWithIcon('#27ae60', 'üêâ')" style="background: #27ae60;">üêâ</div>
                        </div>
                    </details>

                    <div class="btn-group" style="margin-top: 1rem;">
                        <button class="btn btn-primary" onclick="addCustomToken()">+ Custom</button>
                        <button class="btn btn-danger" onclick="clearAllTokens()">Clear All</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-modal">
            <div class="login-header">
                <div class="login-icon">üßô</div>
                <h2>Dungeon Master</h2>
                <p>Enter credentials to access controls</p>
            </div>

            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>USERNAME</label>
                    <input type="text" id="dmUsername" placeholder="Enter username" autocomplete="off" required>
                </div>

                <div class="form-group">
                    <label>PASSWORD</label>
                    <input type="password" id="dmPassword" placeholder="Enter password" autocomplete="off" required>
                </div>

                <div class="error-message" id="loginError">
                    Invalid credentials. Please try again.
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">ENTER</button>
                <button type="button" class="btn" onclick="closeLogin()" style="width: 100%; margin-top: 0.75rem; justify-content: center;">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Player Login Modal -->
    <div class="login-overlay" id="playerLoginOverlay">
        <div class="login-modal">
            <div class="login-header">
                <div class="login-icon">üë§</div>
                <h2>Player Login</h2>
                <p>Join the adventure</p>
            </div>

            <form onsubmit="handlePlayerLogin(event)">
                <div class="form-group">
                    <label>PLAYER NAME</label>
                    <input type="text" id="playerName" placeholder="Enter your character name" autocomplete="off" required>
                </div>

                <div class="form-group">
                    <label>PASSWORD (Optional)</label>
                    <input type="password" id="playerPassword" placeholder="Leave empty for guest" autocomplete="off">
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">JOIN GAME</button>
                <button type="button" class="btn" onclick="closePlayerLogin()" style="width: 100%; margin-top: 0.75rem; justify-content: center;">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Player Token Bar -->
    <div class="player-token-bar" id="playerTokenBar">
        <div class="player-info">
            <div class="player-avatar" id="playerAvatar">üë§</div>
            <div class="player-name" id="displayPlayerName">Guest</div>
        </div>

        <div class="my-tokens" id="myTokens">
            <!-- Player tokens will appear here -->
        </div>

        <div class="token-controls">
            <button class="mini-btn" onclick="showImportToken()">üì§ Import</button>
            <button class="mini-btn" onclick="createPlayerToken()">‚ûï New</button>
            <button class="mini-btn" onclick="playerLogout()">üö™ Logout</button>
        </div>
    </div>

    <!-- Player Login Button -->
    <button class="player-login-btn" id="playerLoginBtn" onclick="showPlayerLogin()">
        üë§
    </button>

    <!-- Hidden file inputs -->
    <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileLoad(event)">
    <input type="file" id="tokenImport" accept="image/*" style="display: none;" onchange="handleTokenImport(event)">

    <script>
        // Login System
        const DM_CREDENTIALS = {
            username: 'Wizard',
            password: 'Wizard'
        };
        
        let isLoggedIn = false;

        function showLogin() {
            document.getElementById('loginOverlay').classList.add('active');
            document.getElementById('dmUsername').focus();
        }

        function closeLogin() {
            document.getElementById('loginOverlay').classList.remove('active');
            document.getElementById('loginError').classList.remove('show');
            document.getElementById('dmUsername').value = '';
            document.getElementById('dmPassword').value = '';
        }

        function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('dmUsername').value;
            const password = document.getElementById('dmPassword').value;
            const errorMsg = document.getElementById('loginError');

            if (username === DM_CREDENTIALS.username && password === DM_CREDENTIALS.password) {
                isLoggedIn = true;
                closeLogin();
                openDMPanel();
                document.getElementById('dmPassword').value = '';
            } else {
                errorMsg.classList.add('show');
                setTimeout(() => errorMsg.classList.remove('show'), 3000);
                document.getElementById('dmPassword').value = '';
                document.getElementById('dmPassword').focus();
            }
        }

        function openDMPanel() {
            if (!isLoggedIn) {
                showLogin();
                return;
            }
            document.getElementById('dmPanel').classList.add('open');
        }

        function closeDMPanel() {
            document.getElementById('dmPanel').classList.remove('open');
        }

        // Player Login System
        let currentPlayer = null;
        let playerTokens = [];
        let selectedPlayerToken = null;

        function showPlayerLogin() {
            document.getElementById('playerLoginOverlay').classList.add('active');
            document.getElementById('playerName').focus();
        }

        function closePlayerLogin() {
            document.getElementById('playerLoginOverlay').classList.remove('active');
            document.getElementById('playerName').value = '';
            document.getElementById('playerPassword').value = '';
        }

        function handlePlayerLogin(event) {
            event.preventDefault();
            
            const name = document.getElementById('playerName').value.trim();
            const password = document.getElementById('playerPassword').value;

            if (!name) return;

            currentPlayer = {
                name: name,
                password: password,
                avatar: getRandomEmoji(),
                tokens: []
            };

            document.getElementById('displayPlayerName').textContent = name;
            document.getElementById('playerAvatar').textContent = currentPlayer.avatar;
            document.getElementById('playerTokenBar').classList.add('show');
            document.getElementById('playerLoginBtn').classList.add('logged-in');
            document.getElementById('playerLoginBtn').textContent = '‚úì';

            closePlayerLogin();
            renderPlayerTokens();
        }

        function playerLogout() {
            if (!confirm('Logout from the game?')) return;
            
            currentPlayer = null;
            playerTokens = [];
            selectedPlayerToken = null;
            document.getElementById('playerTokenBar').classList.remove('show');
            document.getElementById('playerLoginBtn').classList.remove('logged-in');
            document.getElementById('playerLoginBtn').textContent = 'üë§';
            document.getElementById('myTokens').innerHTML = '';
        }

        function getRandomEmoji() {
            const emojis = ['‚öîÔ∏è', 'üõ°Ô∏è', 'üèπ', 'üîÆ', 'üó°Ô∏è', 'ü™Ñ', 'ü¶Å', 'üéµ', 'üßô', 'üßù', 'üßö', 'üßû'];
            return emojis[Math.floor(Math.random() * emojis.length)];
        }

        function createPlayerToken() {
            if (!currentPlayer) {
                showPlayerLogin();
                return;
            }

            const icon = prompt('Enter token emoji/icon:', '‚öîÔ∏è') || '‚öîÔ∏è';
            const color = prompt('Enter hex color (e.g., #ff0000):', '#e74c3c') || '#e74c3c';

            const token = {
                id: Date.now() + Math.random(),
                icon: icon,
                color: color,
                owner: currentPlayer.name
            };

            playerTokens.push(token);
            renderPlayerTokens();
        }

        function renderPlayerTokens() {
            const container = document.getElementById('myTokens');
            container.innerHTML = playerTokens.map(token => `
                <div class="player-token ${selectedPlayerToken === token.id ? 'selected' : ''}" 
                     style="background: ${token.color};"
                     onclick="selectPlayerToken(${token.id})"
                     draggable="true"
                     ondragstart="handleTokenDragStart(event, ${token.id})">
                    ${token.icon}
                </div>
            `).join('');
        }

        function selectPlayerToken(tokenId) {
            selectedPlayerToken = selectedPlayerToken === tokenId ? null : tokenId;
            renderPlayerTokens();
        }

        function handleTokenDragStart(event, tokenId) {
            const token = playerTokens.find(t => t.id === tokenId);
            if (!token) return;

            event.dataTransfer.effectAllowed = 'copy';
            event.dataTransfer.setData('text/plain', JSON.stringify({
                type: 'player-token',
                token: token
            }));
        }

        function showImportToken() {
            if (!currentPlayer) {
                showPlayerLogin();
                return;
            }
            document.getElementById('tokenImport').click();
        }

        function handleTokenImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('Please upload an image file');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const icon = prompt('Enter emoji to represent this token:', 'üé≠') || 'üé≠';
                const color = prompt('Enter background color (hex):', '#3498db') || '#3498db';

                const token = {
                    id: Date.now() + Math.random(),
                    icon: icon,
                    color: color,
                    image: e.target.result,
                    owner: currentPlayer.name
                };

                playerTokens.push(token);
                renderPlayerTokens();
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        }

        // Session Management
        let sessions = [];
        let currentSessionId = null;

        function createSession(name = 'Untitled Session') {
            const session = {
                id: Date.now() + Math.random(),
                name: name,
                created: new Date().toISOString(),
                map: null,
                tokens: [],
                fog: null,
                zoom: 1,
                panX: 0,
                panY: 0
            };
            sessions.push(session);
            return session;
        }

        function createNewSession() {
            const name = prompt('Enter session name:', 'Campaign ' + (sessions.length + 1));
            if (!name) return;
            
            const session = createSession(name);
            currentSessionId = session.id;
            renderTabs();
            switchToSession(session.id);
        }

        function switchToSession(sessionId) {
            currentSessionId = sessionId;
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;

            // Load session state
            document.getElementById('sessionName').textContent = session.name;
            tokens = session.tokens || [];
            zoom = session.zoom || 1;
            panX = session.panX || 0;
            panY = session.panY || 0;
            
            // Load map
            if (session.map) {
                const img = new Image();
                img.onload = function() {
                    backgroundImage = img;
                    drawTable();
                };
                img.src = session.map;
            } else {
                backgroundImage = null;
                drawTable();
            }

            // Load fog
            if (session.fog) {
                const img = new Image();
                img.onload = function() {
                    fogCtx.clearRect(0, 0, fogCanvas.width, fogCanvas.height);
                    fogCtx.drawImage(img, 0, 0);
                    drawTable();
                };
                img.src = session.fog;
            } else {
                resetFog();
            }

            document.getElementById('zoomSlider').value = zoom * 100;
            document.getElementById('zoomValue').textContent = Math.round(zoom * 100) + '%';
            
            renderTabs();
            drawTable();
        }

        function saveCurrentSession() {
            if (!currentSessionId) return;
            
            const session = sessions.find(s => s.id === currentSessionId);
            if (!session) return;

            session.tokens = JSON.parse(JSON.stringify(tokens));
            session.zoom = zoom;
            session.panX = panX;
            session.panY = panY;
            
            if (backgroundImage) {
                session.map = tableCanvas.toDataURL();
            }
            
            session.fog = fogCanvas.toDataURL();
        }

        function deleteSession(sessionId) {
            if (!confirm('Delete this session?')) return;
            
            sessions = sessions.filter(s => s.id !== sessionId);
            
            if (currentSessionId === sessionId) {
                currentSessionId = sessions.length > 0 ? sessions[0].id : null;
                if (currentSessionId) {
                    switchToSession(currentSessionId);
                }
            }
            
            renderTabs();
        }

        function renderTabs() {
            const container = document.getElementById('tabContainer');
            container.innerHTML = sessions.map(session => `
                <div class="tab ${session.id === currentSessionId ? 'active' : ''}" onclick="switchToSession(${session.id})">
                    <span>${session.name}</span>
                    <button class="tab-close" onclick="event.stopPropagation(); deleteSession(${session.id})">√ó</button>
                </div>
            `).join('');
        }

        // Save/Load System
        function saveSession() {
            saveCurrentSession();
            
            const saveData = {
                version: '1.0',
                sessions: sessions.map(s => ({
                    ...s,
                    tokens: s.tokens || []
                })),
                currentSessionId: currentSessionId
            };

            const dataStr = JSON.stringify(saveData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'mystic-tabletop-' + Date.now() + '.json';
            link.click();
            URL.revokeObjectURL(url);

            alert('‚úÖ Session saved successfully!');
        }

        function loadSession() {
            document.getElementById('fileInput').click();
        }

        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!data.sessions || !Array.isArray(data.sessions)) {
                        throw new Error('Invalid save file format');
                    }

                    sessions = data.sessions;
                    currentSessionId = data.currentSessionId || (sessions.length > 0 ? sessions[0].id : null);
                    
                    if (currentSessionId) {
                        switchToSession(currentSessionId);
                    }
                    
                    renderTabs();
                    alert('‚úÖ Sessions loaded successfully!');
                } catch (err) {
                    alert('‚ùå Error loading file: ' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // Drawing Tools
        let currentTool = 'brush';
        let brushSize = 15;
        let currentColor = '#4a7c59';
        let selectedStamp = 'üå≤';
        let fogMode = false;
        let fogBrushSize = 60;
        let revealMode = true;
        let zoom = 1;
        let panX = 0;
        let panY = 0;
        let tokens = [];
        let backgroundImage = null;
        let isDrawing = false;
        let draggedToken = null;
        let lastX = 0;
        let lastY = 0;
        let startX = 0;
        let startY = 0;

        const mapCanvas = document.getElementById('mapCanvas');
        const mapCtx = mapCanvas.getContext('2d');
        const tableCanvas = document.getElementById('tabletopCanvas');
        const tableCtx = tableCanvas.getContext('2d');

        const fogCanvas = document.createElement('canvas');
        const fogCtx = fogCanvas.getContext('2d');
        fogCanvas.width = tableCanvas.width;
        fogCanvas.height = tableCanvas.height;

        function init() {
            mapCtx.fillStyle = '#f5f5dc';
            mapCtx.fillRect(0, 0, mapCanvas.width, mapCanvas.height);

            fogCtx.fillStyle = 'rgba(0, 0, 0, 0.9)';
            fogCtx.fillRect(0, 0, fogCanvas.width, fogCanvas.height);

            // Create default session
            const defaultSession = createSession('The Fractured Sky');
            currentSessionId = defaultSession.id;
            renderTabs();
            
            drawTable();
        }

        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-card').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tool + 'Tool').classList.add('active');
        }

        function updateBrushSize(value) {
            brushSize = value;
            document.getElementById('brushSizeValue').textContent = value + 'px';
        }

        function selectStamp(emoji) {
            selectedStamp = emoji;
            setTool('stamp');
            document.querySelectorAll('.asset-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        document.getElementById('colorPicker').addEventListener('change', (e) => {
            currentColor = e.target.value;
        });

        // Map Canvas Events
        mapCanvas.addEventListener('mousedown', (e) => {
            isDrawing = true;
            const rect = mapCanvas.getBoundingClientRect();
            const scaleX = mapCanvas.width / rect.width;
            const scaleY = mapCanvas.height / rect.height;
            startX = (e.clientX - rect.left) * scaleX;
            startY = (e.clientY - rect.top) * scaleY;
            lastX = startX;
            lastY = startY;

            if (currentTool === 'brush') {
                mapCtx.beginPath();
                mapCtx.moveTo(startX, startY);
                mapCtx.strokeStyle = currentColor;
                mapCtx.lineWidth = brushSize;
                mapCtx.lineCap = 'round';
                mapCtx.lineJoin = 'round';
            } else if (currentTool === 'eraser') {
                mapCtx.beginPath();
                mapCtx.moveTo(startX, startY);
            } else if (currentTool === 'fill') {
                mapCtx.fillStyle = currentColor;
                mapCtx.fillRect(0, 0, mapCanvas.width, mapCanvas.height);
            } else if (currentTool === 'stamp') {
                mapCtx.font = '64px Arial';
                mapCtx.fillText(selectedStamp, startX - 32, startY + 16);
            } else if (currentTool === 'text') {
                const text = prompt('Enter text:');
                if (text) {
                    mapCtx.fillStyle = currentColor;
                    mapCtx.font = '32px Raleway';
                    mapCtx.fillText(text, startX, startY);
                }
            }
        });

        mapCanvas.addEventListener('mousemove', (e) => {
            if (!isDrawing) return;

            const rect = mapCanvas.getBoundingClientRect();
            const scaleX = mapCanvas.width / rect.width;
            const scaleY = mapCanvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            if (currentTool === 'brush') {
                mapCtx.lineTo(x, y);
                mapCtx.stroke();
            } else if (currentTool === 'eraser') {
                mapCtx.globalCompositeOperation = 'destination-out';
                mapCtx.lineWidth = brushSize;
                mapCtx.lineCap = 'round';
                mapCtx.lineTo(x, y);
                mapCtx.stroke();
                mapCtx.globalCompositeOperation = 'source-over';
            }

            lastX = x;
            lastY = y;
        });

        mapCanvas.addEventListener('mouseup', (e) => {
            if (!isDrawing) return;

            const rect = mapCanvas.getBoundingClientRect();
            const scaleX = mapCanvas.width / rect.width;
            const scaleY = mapCanvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            if (currentTool === 'line') {
                mapCtx.strokeStyle = currentColor;
                mapCtx.lineWidth = brushSize;
                mapCtx.lineCap = 'round';
                mapCtx.beginPath();
                mapCtx.moveTo(startX, startY);
                mapCtx.lineTo(x, y);
                mapCtx.stroke();
            } else if (currentTool === 'rect') {
                mapCtx.fillStyle = currentColor;
                mapCtx.fillRect(startX, startY, x - startX, y - startY);
            } else if (currentTool === 'circle') {
                const radius = Math.sqrt(Math.pow(x - startX, 2) + Math.pow(y - startY, 2));
                mapCtx.fillStyle = currentColor;
                mapCtx.beginPath();
                mapCtx.arc(startX, startY, radius, 0, Math.PI * 2);
                mapCtx.fill();
            }

            isDrawing = false;
        });

        mapCanvas.addEventListener('mouseleave', () => {
            isDrawing = false;
        });

        function clearMap() {
            if (confirm('Clear the entire map?')) {
                mapCtx.fillStyle = '#f5f5dc';
                mapCtx.fillRect(0, 0, mapCanvas.width, mapCanvas.height);
            }
        }

        function exportMap() {
            const link = document.createElement('a');
            link.download = 'map-' + Date.now() + '.png';
            link.href = mapCanvas.toDataURL();
            link.click();
        }

        function loadMapToTable() {
            const img = new Image();
            img.onload = function() {
                backgroundImage = img;
                drawTable();
                saveCurrentSession();
            };
            img.src = mapCanvas.toDataURL();
        }

        function handleMapUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('Please upload an image file (PNG, JPG, etc.)');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                // Load to map canvas first
                const img = new Image();
                img.onload = function() {
                    // Clear and resize map canvas to fit image
                    mapCtx.fillStyle = '#f5f5dc';
                    mapCtx.fillRect(0, 0, mapCanvas.width, mapCanvas.height);
                    
                    // Draw uploaded image centered and scaled
                    const scale = Math.min(
                        mapCanvas.width / img.width,
                        mapCanvas.height / img.height
                    );
                    const x = (mapCanvas.width - img.width * scale) / 2;
                    const y = (mapCanvas.height - img.height * scale) / 2;
                    
                    mapCtx.drawImage(img, x, y, img.width * scale, img.height * scale);
                    
                    alert('‚úÖ Map uploaded! Click "Load to Table" to display it.');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        }

        // Virtual Tabletop
        function drawTable() {
            tableCtx.save();
            tableCtx.clearRect(0, 0, tableCanvas.width, tableCanvas.height);

            tableCtx.translate(panX, panY);
            tableCtx.scale(zoom, zoom);

            if (backgroundImage) {
                tableCtx.drawImage(backgroundImage, 0, 0, tableCanvas.width / zoom, tableCanvas.height / zoom);
            } else {
                tableCtx.fillStyle = '#161b22';
                tableCtx.fillRect(0, 0, tableCanvas.width / zoom, tableCanvas.height / zoom);
                tableCtx.strokeStyle = '#1f2937';
                tableCtx.lineWidth = 2 / zoom;
                const gridSize = 50;
                for (let x = 0; x <= tableCanvas.width / zoom; x += gridSize) {
                    tableCtx.beginPath();
                    tableCtx.moveTo(x, 0);
                    tableCtx.lineTo(x, tableCanvas.height / zoom);
                    tableCtx.stroke();
                }
                for (let y = 0; y <= tableCanvas.height / zoom; y += gridSize) {
                    tableCtx.beginPath();
                    tableCtx.moveTo(0, y);
                    tableCtx.lineTo(tableCanvas.width / zoom, y);
                    tableCtx.stroke();
                }
            }

            tokens.forEach(token => {
                // Draw token background
                tableCtx.fillStyle = token.color;
                tableCtx.beginPath();
                tableCtx.arc(token.x, token.y, 30, 0, Math.PI * 2);
                tableCtx.fill();
                
                // Draw border (gold for DM tokens, purple for player tokens)
                tableCtx.strokeStyle = token.owner ? var(--accent-primary) : '#fbbf24';
                tableCtx.lineWidth = 3 / zoom;
                tableCtx.stroke();

                // Draw image or icon
                if (token.image) {
                    // If token has custom image
                    const img = new Image();
                    img.src = token.image;
                    tableCtx.save();
                    tableCtx.beginPath();
                    tableCtx.arc(token.x, token.y, 28, 0, Math.PI * 2);
                    tableCtx.clip();
                    tableCtx.drawImage(img, token.x - 28, token.y - 28, 56, 56);
                    tableCtx.restore();
                } else {
                    // Draw emoji icon
                    tableCtx.fillStyle = '#fff';
                    tableCtx.font = `${32 / zoom}px Arial`;
                    tableCtx.textAlign = 'center';
                    tableCtx.textBaseline = 'middle';
                    tableCtx.fillText(token.icon, token.x, token.y);
                }

                // Draw owner name if player token
                if (token.owner && currentPlayer && token.owner === currentPlayer.name) {
                    tableCtx.fillStyle = 'rgba(139, 92, 246, 0.8)';
                    tableCtx.font = `${12 / zoom}px Raleway`;
                    tableCtx.textAlign = 'center';
                    tableCtx.fillText(token.owner, token.x, token.y + 45);
                }
            });

            tableCtx.restore();

            tableCtx.save();
            tableCtx.translate(panX, panY);
            tableCtx.scale(zoom, zoom);
            tableCtx.drawImage(fogCanvas, 0, 0);
            tableCtx.restore();
        }

        function updateZoom(value) {
            zoom = value / 100;
            document.getElementById('zoomValue').textContent = Math.round(value) + '%';
            drawTable();
            saveCurrentSession();
        }

        // Fog of War
        function updateFogBrush(value) {
            fogBrushSize = parseInt(value);
            document.getElementById('fogBrushValue').textContent = value + 'px';
        }

        function toggleFogMode() {
            fogMode = !fogMode;
            const btn = document.getElementById('fogModeBtn');
            if (fogMode) {
                btn.textContent = 'üå´Ô∏è Fog Active';
                btn.classList.add('btn-success');
                tableCanvas.style.cursor = 'crosshair';
            } else {
                btn.textContent = 'Enable Fog';
                btn.classList.remove('btn-success');
                tableCanvas.style.cursor = 'grab';
            }
        }

        function updateFogMode() {
            revealMode = document.getElementById('revealMode').checked;
        }

        function resetFog() {
            fogCtx.clearRect(0, 0, fogCanvas.width, fogCanvas.height);
            fogCtx.fillStyle = 'rgba(0, 0, 0, 0.9)';
            fogCtx.fillRect(0, 0, fogCanvas.width, fogCanvas.height);
            drawTable();
            saveCurrentSession();
        }

        function applyFog(x, y) {
            if (revealMode) {
                fogCtx.globalCompositeOperation = 'destination-out';
                fogCtx.beginPath();
                fogCtx.arc(x, y, fogBrushSize, 0, Math.PI * 2);
                fogCtx.fill();
            } else {
                fogCtx.globalCompositeOperation = 'source-over';
                fogCtx.fillStyle = 'rgba(0, 0, 0, 0.9)';
                fogCtx.beginPath();
                fogCtx.arc(x, y, fogBrushSize, 0, Math.PI * 2);
                fogCtx.fill();
            }
        }

        // Token Management
        function addTokenWithIcon(color, icon) {
            tokens.push({
                x: (tableCanvas.width / 2 - panX) / zoom,
                y: (tableCanvas.height / 2 - panY) / zoom,
                color: color,
                icon: icon
            });
            drawTable();
            saveCurrentSession();
        }

        function addCustomToken() {
            const icon = prompt('Enter token emoji/icon:') || '‚öîÔ∏è';
            const color = prompt('Enter hex color (e.g., #ff0000):') || '#' + Math.floor(Math.random()*16777215).toString(16);
            addTokenWithIcon(color, icon);
        }

        function clearAllTokens() {
            if (confirm('Remove all tokens?')) {
                tokens = [];
                drawTable();
                saveCurrentSession();
            }
        }

        // Table Canvas Events
        tableCanvas.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        });

        tableCanvas.addEventListener('drop', (e) => {
            e.preventDefault();
            
            try {
                const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                if (data.type === 'player-token') {
                    const rect = tableCanvas.getBoundingClientRect();
                    const x = (e.clientX - rect.left - panX) / zoom;
                    const y = (e.clientY - rect.top - panY) / zoom;

                    tokens.push({
                        x: x,
                        y: y,
                        color: data.token.color,
                        icon: data.token.icon,
                        owner: data.token.owner,
                        image: data.token.image || null
                    });

                    drawTable();
                    saveCurrentSession();
                }
            } catch (err) {
                // Not a player token drop
            }
        });

        tableCanvas.addEventListener('mousedown', (e) => {
            const rect = tableCanvas.getBoundingClientRect();
            const mouseX = (e.clientX - rect.left - panX) / zoom;
            const mouseY = (e.clientY - rect.top - panY) / zoom;

            if (fogMode) {
                isDrawing = true;
                applyFog(mouseX, mouseY);
                drawTable();
                return;
            }

            draggedToken = tokens.find(token => {
                const dx = mouseX - token.x;
                const dy = mouseY - token.y;
                const isNearToken = Math.sqrt(dx * dx + dy * dy) < 30;
                
                // Players can only move their own tokens
                if (currentPlayer && token.owner) {
                    return isNearToken && token.owner === currentPlayer.name;
                }
                
                // DM can move any token without owner, or if logged in as DM
                return isNearToken && (!token.owner || isLoggedIn);
            });

            if (draggedToken) {
                isDrawing = true;
            } else {
                lastX = e.clientX;
                lastY = e.clientY;
                isDrawing = true;
            }
        });

        tableCanvas.addEventListener('mousemove', (e) => {
            if (!isDrawing) return;

            const rect = tableCanvas.getBoundingClientRect();
            const mouseX = (e.clientX - rect.left - panX) / zoom;
            const mouseY = (e.clientY - rect.top - panY) / zoom;

            if (fogMode) {
                applyFog(mouseX, mouseY);
                drawTable();
                return;
            }

            if (draggedToken) {
                draggedToken.x = mouseX;
                draggedToken.y = mouseY;
            } else {
                panX += e.clientX - lastX;
                panY += e.clientY - lastY;
                lastX = e.clientX;
                lastY = e.clientY;
            }

            drawTable();
        });

        tableCanvas.addEventListener('mouseup', () => {
            if (isDrawing && (draggedToken || fogMode)) {
                saveCurrentSession();
            }
            isDrawing = false;
            draggedToken = null;
        });

        tableCanvas.addEventListener('mouseleave', () => {
            if (isDrawing && (draggedToken || fogMode)) {
                saveCurrentSession();
            }
            isDrawing = false;
            draggedToken = null;
        });

        // Initialize
        init();
    </script>
</body>
</html>
