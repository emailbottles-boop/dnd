<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Fractured Sky - Virtual Tabletop</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #0a0e1a;
            --bg-card: #151928;
            --bg-hover: #1f2537;
            --accent: #8b5cf6;
            --accent-secondary: #ec4899;
            --gold: #fbbf24;
            --text: #e5e7eb;
            --text-dim: #9ca3af;
            --border: rgba(139, 92, 246, 0.2);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
        }

        .header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .title {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--gold), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
        }

        .btn {
            padding: 0.6rem 1.2rem;
            background: var(--bg-hover);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--accent);
            border-color: var(--accent);
            transform: translateY(-1px);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            border: none;
            color: white;
        }

        .btn-small {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
        }

        .container {
            display: flex;
            height: calc(100vh - 70px);
        }

        .main-area {
            flex: 1;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }

        .tabletop {
            flex: 1;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        }

        .tabletop-header {
            padding: 1rem 1.5rem;
            background: var(--bg-hover);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .session-name {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            background: linear-gradient(135deg, var(--gold), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .slider {
            width: 120px;
            height: 4px;
            background: var(--bg-dark);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
        }

        .canvas-container {
            flex: 1;
            position: relative;
            background: radial-gradient(circle at center, #1a1f2e 0%, var(--bg-dark) 100%);
            overflow: hidden;
        }

        #mainCanvas {
            display: block;
            cursor: grab;
        }

        #mainCanvas:active {
            cursor: grabbing;
        }

        /* Stamp Sidebar - DM Only */
        .stamp-sidebar {
            width: 280px;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            transform: translateX(-100%);
            transition: transform 0.3s;
            box-shadow: 5px 0 20px rgba(0,0,0,0.3);
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 150;
        }

        .stamp-sidebar.open {
            transform: translateX(0);
        }

        .stamp-header {
            position: sticky;
            top: 0;
            background: var(--bg-hover);
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .stamp-content {
            padding: 1rem;
        }

        .stamp-category {
            margin-bottom: 1.5rem;
        }

        .stamp-category h4 {
            color: var(--gold);
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stamp-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }

        .stamp-item {
            aspect-ratio: 1;
            background: var(--bg-hover);
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .stamp-item:hover {
            transform: scale(1.1);
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.3);
        }

        .stamp-item.selected {
            border-color: var(--gold);
            background: rgba(251, 191, 36, 0.1);
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.4);
        }

        /* DM Panel */
        .dm-panel {
            width: 400px;
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.3s;
        }

        .dm-panel.open {
            transform: translateX(0);
        }

        .dm-header {
            position: sticky;
            top: 0;
            background: var(--bg-hover);
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .dm-content {
            padding: 1rem;
        }

        .section {
            background: var(--bg-hover);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s;
        }

        .section.active {
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
            background: rgba(139, 92, 246, 0.05);
        }

        .section h3 {
            margin-bottom: 0.75rem;
            color: var(--gold);
            font-size: 1rem;
        }

        .section.active h3 {
            color: var(--accent);
        }

        .tool-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin: 0.75rem 0;
        }

        .tool-btn {
            padding: 0.75rem;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .tool-btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent);
        }

        .tool-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .control-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin: 0.75rem 0;
        }

        .control-row label {
            min-width: 60px;
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        input[type="color"] {
            width: 50px;
            height: 36px;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
        }

        .grid-selector {
            background: var(--bg-dark);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 2px solid var(--border);
        }

        .grid-selector.active {
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.3);
        }

        .grid-info {
            font-size: 0.9rem;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .grid-info .current {
            color: var(--accent);
            font-weight: 600;
            font-size: 1.1rem;
        }

        .grid-nav {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .grid-nav button:nth-child(2) {
            grid-column: 2;
        }

        .grid-nav button:nth-child(3) {
            grid-column: 3;
        }

        .grid-nav button:nth-child(4) {
            grid-column: 1;
        }

        .grid-nav button:nth-child(5) {
            grid-column: 2;
        }

        .grid-nav button:nth-child(6) {
            grid-column: 3;
        }

        #mapCanvas {
            width: 100%;
            height: 250px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: white;
            cursor: crosshair;
            margin: 0.5rem 0;
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .asset-library {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin: 0.75rem 0;
        }

        .asset-item {
            aspect-ratio: 1;
            background: var(--bg-dark);
            border: 2px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            gap: 0.25rem;
            transition: all 0.2s;
            padding: 0.5rem;
        }

        .asset-item:hover {
            border-color: var(--accent);
            transform: scale(1.05);
        }

        .asset-item.selected {
            border-color: var(--gold);
            background: rgba(251, 191, 36, 0.1);
        }

        .asset-preview {
            font-size: 1.5rem;
        }

        .player-requests {
            max-height: 200px;
            overflow-y: auto;
        }

        .player-request {
            background: var(--bg-dark);
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .modal-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .modal-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-dim);
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.95rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            color: #ef4444;
            padding: 0.75rem;
            border-radius: 6px;
            margin: 1rem 0;
            display: none;
        }

        .error.show {
            display: block;
        }

        .success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #10b981;
            color: #10b981;
            padding: 0.75rem;
            border-radius: 6px;
            margin: 1rem 0;
            display: none;
        }

        .success.show {
            display: block;
        }

        .player-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            padding: 0.75rem 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            transform: translateY(100%);
            transition: transform 0.3s;
            z-index: 50;
        }

        .player-bar.show {
            transform: translateY(0);
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-hover);
            border-radius: 8px;
        }

        .player-tokens {
            flex: 1;
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
        }

        .token {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border: 2px solid var(--border);
            cursor: move;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .token:hover {
            transform: scale(1.1);
            border-color: var(--accent);
        }

        .player-login-btn {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            border: 3px solid var(--gold);
            border-radius: 50%;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.6), 0 0 0 0 rgba(139, 92, 246, 0.7);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 6px 20px rgba(139, 92, 246, 0.6), 0 0 0 0 rgba(139, 92, 246, 0.7);
            }
            50% {
                box-shadow: 0 6px 20px rgba(139, 92, 246, 0.6), 0 0 0 15px rgba(139, 92, 246, 0);
            }
        }

        .player-login-btn:hover {
            transform: scale(1.15);
            box-shadow: 0 8px 30px rgba(139, 92, 246, 0.8);
        }

        .player-login-btn::before {
            content: 'PLAYER LOGIN';
            position: absolute;
            top: -35px;
            right: 0;
            background: var(--bg-card);
            color: var(--text);
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            border: 1px solid var(--border);
        }

        .player-login-btn:hover::before {
            opacity: 1;
        }

        /* Initial Tooltip */
        .player-tooltip {
            position: fixed;
            bottom: 2rem;
            right: 9rem;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            white-space: nowrap;
            z-index: 99;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.6);
            animation: bounce 2s infinite;
            transition: opacity 0.3s, transform 0.3s;
        }

        .player-tooltip.hidden {
            opacity: 0;
            transform: translateX(20px);
            pointer-events: none;
        }

        .player-tooltip::after {
            content: '';
            position: absolute;
            right: -15px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid var(--accent-secondary);
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateX(0);
            }
            50% {
                transform: translateX(-10px);
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">‚ú® THE FRACTURED SKY</div>
        <div class="header-actions">
            <button class="btn" onclick="saveGame()" id="saveBtn">üíæ Save</button>
            <button class="btn" onclick="loadGame()">üìÇ Load</button>
            <button class="btn btn-primary" onclick="openDM()">üé≠ DM Controls</button>
        </div>
    </div>

    <div class="container">
        <div class="main-area">
            <div class="tabletop">
                <div class="tabletop-header">
                    <div class="session-name">The Fractured Sky</div>
                    <div class="zoom-controls">
                        <span style="color: var(--text-dim); font-size: 0.9rem;">Zoom:</span>
                        <input type="range" class="slider" id="zoomSlider" min="25" max="200" value="100" oninput="setZoom(this.value)">
                        <span id="zoomValue" style="min-width: 50px; font-size: 0.9rem;">100%</span>
                    </div>
                </div>
                <div class="canvas-container" id="canvasContainer">
                    <!-- Stamp Sidebar (DM Only) -->
                    <div class="stamp-sidebar" id="stampSidebar">
                        <div class="stamp-header">
                            <h3 style="color: var(--gold);">üè∞ Stamp Library</h3>
                            <button class="btn btn-small" onclick="closeStamps()">‚úï</button>
                        </div>
                        <div class="stamp-content">
                            <div class="stamp-category">
                                <h4>üå≤ Vegetation</h4>
                                <div class="stamp-grid">
                                    <div class="stamp-item" onclick="selectStamp('üå≤')">üå≤</div>
                                    <div class="stamp-item" onclick="selectStamp('üå≥')">üå≥</div>
                                    <div class="stamp-item" onclick="selectStamp('üå¥')">üå¥</div>
                                    <div class="stamp-item" onclick="selectStamp('üéã')">üéã</div>
                                    <div class="stamp-item" onclick="selectStamp('üçÉ')">üçÉ</div>
                                    <div class="stamp-item" onclick="selectStamp('üçÑ')">üçÑ</div>
                                    <div class="stamp-item" onclick="selectStamp('üåª')">üåª</div>
                                    <div class="stamp-item" onclick="selectStamp('üåπ')">üåπ</div>
                                </div>
                            </div>
                            <div class="stamp-category">
                                <h4>üèîÔ∏è Natural Features</h4>
                                <div class="stamp-grid">
                                    <div class="stamp-item" onclick="selectStamp('üèîÔ∏è')">üèîÔ∏è</div>
                                    <div class="stamp-item" onclick="selectStamp('‚õ∞Ô∏è')">‚õ∞Ô∏è</div>
                                    <div class="stamp-item" onclick="selectStamp('üóª')">üóª</div>
                                    <div class="stamp-item" onclick="selectStamp('üåã')">üåã</div>
                                    <div class="stamp-item" onclick="selectStamp('üèùÔ∏è')">üèùÔ∏è</div>
                                    <div class="stamp-item" onclick="selectStamp('üèúÔ∏è')">üèúÔ∏è</div>
                                </div>
                            </div>
                            <div class="stamp-category">
                                <h4>üè∞ Buildings</h4>
                                <div class="stamp-grid">
                                    <div class="stamp-item" onclick="selectStamp('üè∞')">üè∞</div>
                                    <div class="stamp-item" onclick="selectStamp('üèØ')">üèØ</div>
                                    <div class="stamp-item" onclick="selectStamp('üèõÔ∏è')">üèõÔ∏è</div>
                                    <div class="stamp-item" onclick="selectStamp('‚õ™')">‚õ™</div>
                                    <div class="stamp-item" onclick="selectStamp('üèòÔ∏è')">üèòÔ∏è</div>
                                    <div class="stamp-item" onclick="selectStamp('üè†')">üè†</div>
                                    <div class="stamp-item" onclick="selectStamp('‚õ∫')">‚õ∫</div>
                                    <div class="stamp-item" onclick="selectStamp('üóº')">üóº</div>
                                </div>
                            </div>
                            <div class="stamp-category">
                                <h4>‚öîÔ∏è Objects</h4>
                                <div class="stamp-grid">
                                    <div class="stamp-item" onclick="selectStamp('‚öîÔ∏è')">‚öîÔ∏è</div>
                                    <div class="stamp-item" onclick="selectStamp('üó°Ô∏è')">üó°Ô∏è</div>
                                    <div class="stamp-item" onclick="selectStamp('üõ°Ô∏è')">üõ°Ô∏è</div>
                                    <div class="stamp-item" onclick="selectStamp('üèπ')">üèπ</div>
                                    <div class="stamp-item" onclick="selectStamp('üîÆ')">üîÆ</div>
                                    <div class="stamp-item" onclick="selectStamp('üíé')">üíé</div>
                                    <div class="stamp-item" onclick="selectStamp('üî•')">üî•</div>
                                    <div class="stamp-item" onclick="selectStamp('‚ö°')">‚ö°</div>
                                </div>
                            </div>
                            <div class="stamp-category">
                                <h4>üêâ Creatures</h4>
                                <div class="stamp-grid">
                                    <div class="stamp-item" onclick="selectStamp('üêâ')">üêâ</div>
                                    <div class="stamp-item" onclick="selectStamp('ü¶Ö')">ü¶Ö</div>
                                    <div class="stamp-item" onclick="selectStamp('üê∫')">üê∫</div>
                                    <div class="stamp-item" onclick="selectStamp('ü¶Å')">ü¶Å</div>
                                    <div class="stamp-item" onclick="selectStamp('üêª')">üêª</div>
                                    <div class="stamp-item" onclick="selectStamp('üíÄ')">üíÄ</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <canvas id="mainCanvas"></canvas>
                </div>
            </div>
        </div>

        <!-- DM Panel -->
        <div class="dm-panel" id="dmPanel">
            <div class="dm-header">
                <h2>üé≠ Dungeon Master</h2>
                <button class="btn btn-small" onclick="closeDM()">‚úï</button>
            </div>
            <div class="dm-content">
                <!-- Player Requests -->
                <div class="section">
                    <h3>üë• Player Requests</h3>
                    <div class="player-requests" id="playerRequests">
                        <p style="color: var(--text-dim); font-size: 0.85rem;">No pending requests</p>
                    </div>
                </div>

                <!-- Grid Map Builder -->
                <div class="section" id="mapSection">
                    <h3>üó∫Ô∏è Grid Map Builder (3x3)</h3>
                    
                    <div class="grid-selector active">
                        <div class="grid-info">
                            Cell: <span class="current" id="currentCell">Center (5)</span>
                        </div>
                        <div class="grid-nav">
                            <button class="btn btn-small" onclick="moveGrid(-1, -1)">‚Üñ</button>
                            <button class="btn btn-small" onclick="moveGrid(0, -1)">‚Üë</button>
                            <button class="btn btn-small" onclick="moveGrid(1, -1)">‚Üó</button>
                            <button class="btn btn-small" onclick="moveGrid(-1, 0)">‚Üê</button>
                            <button class="btn btn-small" style="background: var(--accent); color: white; cursor: default;" disabled>‚óè</button>
                            <button class="btn btn-small" onclick="moveGrid(1, 0)">‚Üí</button>
                            <button class="btn btn-small" onclick="moveGrid(-1, 1)">‚Üô</button>
                            <button class="btn btn-small" onclick="moveGrid(0, 1)">‚Üì</button>
                            <button class="btn btn-small" onclick="moveGrid(1, 1)">‚Üò</button>
                        </div>
                    </div>

                    <div class="tool-grid">
                        <div class="tool-btn active" onclick="setTool('brush')" id="brushBtn">üñåÔ∏è<br>Brush</div>
                        <div class="tool-btn" onclick="setTool('fill')" id="fillBtn">ü™£<br>Fill</div>
                        <div class="tool-btn" onclick="setTool('eraser')" id="eraserBtn">üßπ<br>Erase</div>
                        <div class="tool-btn" onclick="setTool('stamp'); openStamps();" id="stampBtn">üè∞<br>Stamps</div>
                    </div>

                    <div class="control-row">
                        <label>Color:</label>
                        <input type="color" id="colorPicker" value="#4a7c59">
                    </div>
                    <div class="control-row">
                        <label>Size:</label>
                        <input type="range" class="slider" id="sizeSlider" min="1" max="30" value="8" oninput="setSize(this.value)" style="flex: 1;">
                        <span id="sizeValue">8px</span>
                    </div>

                    <canvas id="mapCanvas" width="400" height="400"></canvas>

                    <div class="btn-group">
                        <input type="file" id="mapImport" accept="image/*" style="display: none;" onchange="importMap(event)">
                        <button class="btn" onclick="document.getElementById('mapImport').click()">üì§ Import</button>
                        <button class="btn btn-primary" onclick="submitCell()" style="flex: 1;">‚úì Submit</button>
                        <button class="btn" onclick="clearCell()">Clear</button>
                    </div>
                </div>

                <!-- Textures & Patterns -->
                <div class="section" id="assetSection">
                    <h3>üé® Textures & Patterns</h3>
                    <div class="asset-library">
                        <div class="asset-item" onclick="applyTexture('grass')">
                            <div class="asset-preview">üü©</div>
                            <div>Grass</div>
                        </div>
                        <div class="asset-item" onclick="applyTexture('stone')">
                            <div class="asset-preview">‚¨ú</div>
                            <div>Stone</div>
                        </div>
                        <div class="asset-item" onclick="applyTexture('dirt')">
                            <div class="asset-preview">üü´</div>
                            <div>Dirt</div>
                        </div>
                        <div class="asset-item" onclick="applyTexture('water')">
                            <div class="asset-preview">üü¶</div>
                            <div>Water</div>
                        </div>
                        <div class="asset-item" onclick="applyTexture('gravel')">
                            <div class="asset-preview">ü™®</div>
                            <div>Gravel</div>
                        </div>
                        <div class="asset-item" onclick="applyTexture('sand')">
                            <div class="asset-preview">üü®</div>
                            <div>Sand</div>
                        </div>
                        <div class="asset-item" onclick="applyTexture('wood')">
                            <div class="asset-preview">ü™µ</div>
                            <div>Wood</div>
                        </div>
                        <div class="asset-item" onclick="applyTexture('brick')">
                            <div class="asset-preview">üß±</div>
                            <div>Brick</div>
                        </div>
                        <div class="asset-item" onclick="applyTexture('bridge')">
                            <div class="asset-preview">üåâ</div>
                            <div>Bridge</div>
                        </div>
                    </div>
                    <input type="file" id="assetImport" accept="image/*" style="display: none;" onchange="importAsset(event)">
                    <button class="btn" onclick="document.getElementById('assetImport').click()" style="width: 100%; margin-top: 0.5rem;">üì§ Import Asset</button>
                </div>

                <!-- Fog -->
                <div class="section" id="fogSection">
                    <h3>üå´Ô∏è Fog of War</h3>
                    <div class="control-row">
                        <label>Size:</label>
                        <input type="range" class="slider" id="fogSize" min="20" max="150" value="60" oninput="setFogSize(this.value)" style="flex: 1;">
                        <span id="fogSizeValue">60px</span>
                    </div>
                    <div class="control-row">
                        <label>
                            <input type="checkbox" id="revealMode" checked> Reveal
                        </label>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="toggleFog()" id="fogBtn">Enable Fog</button>
                        <button class="btn" onclick="resetFog()">Reset</button>
                    </div>
                </div>

                <!-- Tokens -->
                <div class="section" id="tokensSection">
                    <h3>üé≤ Tokens</h3>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="addToken('#e74c3c', '‚öîÔ∏è')">‚öîÔ∏è</button>
                        <button class="btn btn-primary" onclick="addToken('#3498db', 'üõ°Ô∏è')">üõ°Ô∏è</button>
                        <button class="btn btn-primary" onclick="addToken('#2ecc71', 'üèπ')">üèπ</button>
                        <button class="btn btn-primary" onclick="addToken('#9b59b6', 'üîÆ')">üîÆ</button>
                    </div>
                    <button class="btn" onclick="addCustomToken()" style="width: 100%; margin-top: 0.5rem;">+ Custom Token</button>
                </div>
            </div>
        </div>
    </div>

    <!-- DM Login Modal -->
    <div class="modal" id="dmModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">üßô</div>
                <h2>Dungeon Master</h2>
            </div>
            <form onsubmit="dmLogin(event)">
                <div class="form-group">
                    <label>USERNAME</label>
                    <input type="text" id="dmUser" placeholder="Enter username" autocomplete="off" required>
                </div>
                <div class="form-group">
                    <label>PASSWORD</label>
                    <input type="password" id="dmPass" placeholder="Enter password" autocomplete="off" required>
                </div>
                <div class="error" id="dmError">Invalid credentials</div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">ENTER</button>
                <button type="button" class="btn" onclick="closeDMModal()" style="width: 100%; margin-top: 0.5rem;">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Player Login Modal -->
    <div class="modal" id="playerModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">üë§</div>
                <h2>Player Login</h2>
            </div>
            <form onsubmit="requestPlayerLogin(event)">
                <div class="form-group">
                    <label>CHARACTER NAME</label>
                    <input type="text" id="playerName" placeholder="Enter your name" autocomplete="off" required>
                </div>
                <div class="success" id="playerSuccess">Request sent! Waiting for DM approval...</div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">REQUEST TO JOIN</button>
                <button type="button" class="btn" onclick="closePlayerModal()" style="width: 100%; margin-top: 0.5rem;">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Player Bar -->
    <div class="player-bar" id="playerBar">
        <div class="player-info">
            <div style="width: 36px; height: 36px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">üë§</div>
            <span id="playerNameDisplay">Guest</span>
        </div>
        <div class="player-tokens" id="playerTokens"></div>
        <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-small" onclick="createPlayerToken()">+ Token</button>
            <button class="btn btn-small" onclick="playerLogout()">Logout</button>
        </div>
    </div>

    <!-- Player Tooltip -->
    <div class="player-tooltip" id="playerTooltip">
        üëà Create Player Token
    </div>

    <button class="player-login-btn" onclick="showPlayerLogin()" id="playerBtn">üë§</button>

    <input type="file" id="fileLoad" accept=".json" style="display: none;" onchange="handleLoad(event)">

    <script>
        // State
        let isDM = false;
        let currentPlayer = null;
        let zoom = 1;
        let panX = 0;
        let panY = 0;
        let tokens = [];
        let tool = 'brush';
        let color = '#4a7c59';
        let size = 8;
        let stamp = 'üå≤';
        let fogSize = 60;
        let currentMode = 'map';
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let dragToken = null;
        let playerTokens = [];
        let playerRequests = [];
        let approvedPlayers = [];
        
        // 3x3 Grid system - FIXED: Now properly tracks grid position
        const GRID_SIZE = 400;
        const CELL_SIZE = 400;
        let currentGridX = 0;  // This represents which 3x3 grid we're viewing
        let currentGridY = 0;
        let gridCells = {};

        const gridNames = [
            ['NW (1)', 'N (2)', 'NE (3)'],
            ['W (4)', 'Center (5)', 'E (6)'],
            ['SW (7)', 'S (8)', 'SE (9)']
        ];

        // Canvas
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const mapCanvas = document.getElementById('mapCanvas');
        const mapCtx = mapCanvas.getContext('2d');
        const fogCanvas = document.createElement('canvas');
        const fogCtx = fogCanvas.getContext('2d');

        function resizeCanvas() {
            const container = document.getElementById('canvasContainer');
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;
            fogCanvas.width = GRID_SIZE * 3;
            fogCanvas.height = GRID_SIZE * 3;
            
            // Center the 3x3 grid in the viewport
            panX = (canvas.width - GRID_SIZE * 3) / 2;
            panY = (canvas.height - GRID_SIZE * 3) / 2;
            
            draw();
        }

        function init() {
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            mapCtx.fillStyle = '#f5f5dc';
            mapCtx.fillRect(0, 0, mapCanvas.width, mapCanvas.height);
            fogCtx.fillStyle = 'rgba(0,0,0,0.9)';
            fogCtx.fillRect(0, 0, fogCanvas.width, fogCanvas.height);
            setMode('map');
            updateGridDisplay();
            updateSaveButton();  // Initialize save button state
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(panX, panY);
            ctx.scale(zoom, zoom);

            // Draw 3x3 grid - the viewport always shows a 3x3 grid
            // The center cell (1,1) is at the current builder position (currentGridX, currentGridY)
            for (let row = 0; row < 3; row++) {
                for (let col = 0; col < 3; col++) {
                    const x = col * GRID_SIZE;
                    const y = row * GRID_SIZE;
                    
                    // Calculate the absolute grid position for this cell
                    // Center of viewport (col=1, row=1) corresponds to (currentGridX, currentGridY)
                    const absoluteX = currentGridX + (col - 1);
                    const absoluteY = currentGridY + (row - 1);
                    const key = `${absoluteX},${absoluteY}`;
                    
                    // Cell background
                    ctx.fillStyle = '#1a1f2e';
                    ctx.fillRect(x, y, GRID_SIZE, GRID_SIZE);
                    
                    // Cell content
                    if (gridCells[key]) {
                        ctx.drawImage(gridCells[key], x, y, GRID_SIZE, GRID_SIZE);
                    }
                    
                    // Grid lines
                    ctx.strokeStyle = '#2a2f3e';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x, y, GRID_SIZE, GRID_SIZE);
                    
                    // Highlight center cell (where DM is currently building)
                    if (col === 1 && row === 1 && isDM) {
                        ctx.strokeStyle = '#8b5cf6';
                        ctx.lineWidth = 4;
                        ctx.strokeRect(x, y, GRID_SIZE, GRID_SIZE);
                        
                        // Cell label showing current build position
                        ctx.fillStyle = 'rgba(139, 92, 246, 0.3)';
                        ctx.fillRect(x + 5, y + 5, 150, 30);
                        ctx.fillStyle = '#8b5cf6';
                        ctx.font = 'bold 14px Inter';
                        ctx.textAlign = 'left';
                        ctx.textBaseline = 'top';
                        ctx.fillText(`Building: (${currentGridX}, ${currentGridY})`, x + 10, y + 12);
                    }
                }
            }

            // Tokens
            tokens.forEach(t => {
                ctx.fillStyle = t.color;
                ctx.beginPath();
                ctx.arc(t.x, t.y, 30, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#fbbf24';
                ctx.lineWidth = 3;
                ctx.stroke();
                ctx.fillStyle = '#fff';
                ctx.font = '32px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(t.icon, t.x, t.y);
                if (t.owner) {
                    ctx.fillStyle = '#8b5cf6';
                    ctx.font = '12px Inter';
                    ctx.fillText(t.owner, t.x, t.y + 45);
                }
            });

            ctx.restore();

            // Fog layer over the entire 3x3 grid
            ctx.save();
            ctx.translate(panX, panY);
            ctx.scale(zoom, zoom);
            ctx.drawImage(fogCanvas, 0, 0, GRID_SIZE * 3, GRID_SIZE * 3);
            ctx.restore();
        }

        // FIXED: Grid navigation now properly updates position
        function moveGrid(dx, dy) {
            // Update the grid position
            currentGridX += dx;
            currentGridY += dy;
            
            // Load the cell at the new center position
            const key = `${currentGridX},${currentGridY}`;
            if (gridCells[key]) {
                mapCtx.clearRect(0, 0, mapCanvas.width, mapCanvas.height);
                mapCtx.drawImage(gridCells[key], 0, 0);
            } else {
                // Clear the canvas if no cell exists at this position
                mapCtx.fillStyle = '#f5f5dc';
                mapCtx.fillRect(0, 0, mapCanvas.width, mapCanvas.height);
            }
            
            updateGridDisplay();
            draw();
        }

        function updateGridDisplay() {
            // Display current absolute grid position
            document.getElementById('currentCell').textContent = `(${currentGridX}, ${currentGridY})`;
        }

        function submitCell() {
            const key = `${currentGridX},${currentGridY}`;
            const cellCanvas = document.createElement('canvas');
            cellCanvas.width = CELL_SIZE;
            cellCanvas.height = CELL_SIZE;
            const cellCtx = cellCanvas.getContext('2d');
            cellCtx.drawImage(mapCanvas, 0, 0);
            gridCells[key] = cellCanvas;
            draw();
            alert(`Cell (${currentGridX}, ${currentGridY}) submitted to grid!`);
        }

        function clearCell() {
            mapCtx.fillStyle = '#f5f5dc';
            mapCtx.fillRect(0, 0, mapCanvas.width, mapCanvas.height);
        }

        // FIXED: Mode setting now properly manages active sections
        function setMode(mode) {
            currentMode = mode;
            
            // Remove active class from ALL sections
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            // Add active class to the appropriate section
            if (mode === 'map') {
                const mapSection = document.getElementById('mapSection');
                if (mapSection) mapSection.classList.add('active');
                canvas.style.cursor = 'grab';
            } else if (mode === 'fog') {
                const fogSection = document.getElementById('fogSection');
                if (fogSection) fogSection.classList.add('active');
                canvas.style.cursor = 'crosshair';
            } else if (mode === 'token') {
                const tokenSection = document.getElementById('tokensSection');
                if (tokenSection) tokenSection.classList.add('active');
                canvas.style.cursor = 'default';
            } else if (mode === 'assets') {
                const assetSection = document.getElementById('assetSection');
                if (assetSection) assetSection.classList.add('active');
                canvas.style.cursor = 'grab';
            }
            
            updateFogButton();
        }

        function updateFogButton() {
            const btn = document.getElementById('fogBtn');
            if (currentMode === 'fog') {
                btn.textContent = 'üå´Ô∏è Fog Active';
                btn.classList.add('btn-primary');
            } else {
                btn.textContent = 'Enable Fog';
                btn.classList.remove('btn-primary');
            }
        }

        // Tools
        function setTool(t) {
            tool = t;
            setMode('map');
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById(t + 'Btn');
            if (btn) btn.classList.add('active');
        }

        function setSize(v) {
            size = v;
            document.getElementById('sizeValue').textContent = v + 'px';
        }

        // Stamps (DM Only)
        function openStamps() {
            if (!isDM) return;
            document.getElementById('stampSidebar').classList.add('open');
            tool = 'stamp';
            setMode('map');
        }

        function closeStamps() {
            document.getElementById('stampSidebar').classList.remove('open');
        }

        function selectStamp(s) {
            stamp = s;
            document.querySelectorAll('.stamp-item').forEach(item => item.classList.remove('selected'));
            event.target.classList.add('selected');
            closeStamps();
            setTool('stamp');
        }

        document.getElementById('colorPicker').addEventListener('change', e => {
            color = e.target.value;
        });

        // Textures
        const textures = {
            grass: '#4a7c59',
            stone: '#8a8a8a',
            dirt: '#8b4513',
            water: '#1e90ff',
            gravel: '#696969',
            sand: '#f4a460',
            wood: '#daa520',
            brick: '#b22222'
        };

        function applyTexture(type) {
            setMode('assets');  // Activate the assets section when clicked
            
            if (type === 'bridge') {
                mapCtx.font = '96px Arial';
                mapCtx.fillText('üåâ', 150, 250);
            } else if (textures[type]) {
                mapCtx.fillStyle = textures[type];
                mapCtx.fillRect(0, 0, mapCanvas.width, mapCanvas.height);
            }
            document.querySelectorAll('.asset-item').forEach(item => item.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        // Import
        function importMap(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                const img = new Image();
                img.onload = () => {
                    mapCtx.drawImage(img, 0, 0, mapCanvas.width, mapCanvas.height);
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        }

        function importAsset(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                const img = new Image();
                img.onload = () => {
                    mapCtx.drawImage(img, 50, 50, 300, 300);
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Map Canvas
        mapCanvas.addEventListener('mousedown', e => {
            isDrawing = true;
            const rect = mapCanvas.getBoundingClientRect();
            const scaleX = mapCanvas.width / rect.width;
            const scaleY = mapCanvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            lastX = x;
            lastY = y;

            if (tool === 'brush') {
                mapCtx.beginPath();
                mapCtx.moveTo(x, y);
                mapCtx.strokeStyle = color;
                mapCtx.lineWidth = size;
                mapCtx.lineCap = 'round';
            } else if (tool === 'fill') {
                mapCtx.fillStyle = color;
                mapCtx.fillRect(0, 0, mapCanvas.width, mapCanvas.height);
            } else if (tool === 'stamp') {
                mapCtx.font = '48px Arial';
                mapCtx.fillText(stamp, x - 24, y + 12);
            } else if (tool === 'eraser') {
                mapCtx.globalCompositeOperation = 'destination-out';
                mapCtx.beginPath();
                mapCtx.moveTo(x, y);
                mapCtx.lineWidth = size;
            }
        });

        mapCanvas.addEventListener('mousemove', e => {
            if (!isDrawing) return;
            const rect = mapCanvas.getBoundingClientRect();
            const scaleX = mapCanvas.width / rect.width;
            const scaleY = mapCanvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            if (tool === 'brush') {
                mapCtx.lineTo(x, y);
                mapCtx.stroke();
            } else if (tool === 'eraser') {
                mapCtx.lineTo(x, y);
                mapCtx.stroke();
            }
        });

        mapCanvas.addEventListener('mouseup', () => {
            isDrawing = false;
            if (tool === 'eraser') {
                mapCtx.globalCompositeOperation = 'source-over';
            }
        });

        // Fog
        function setFogSize(v) {
            fogSize = v;
            document.getElementById('fogSizeValue').textContent = v + 'px';
        }

        function toggleFog() {
            if (currentMode === 'fog') {
                setMode('map');
            } else {
                setMode('fog');
            }
        }

        function resetFog() {
            fogCtx.fillStyle = 'rgba(0,0,0,0.9)';
            fogCtx.fillRect(0, 0, fogCanvas.width, fogCanvas.height);
            draw();
        }

        function applyFog(x, y) {
            const reveal = document.getElementById('revealMode').checked;
            if (reveal) {
                fogCtx.globalCompositeOperation = 'destination-out';
            } else {
                fogCtx.globalCompositeOperation = 'source-over';
                fogCtx.fillStyle = 'rgba(0,0,0,0.9)';
            }
            fogCtx.beginPath();
            fogCtx.arc(x, y, fogSize, 0, Math.PI * 2);
            fogCtx.fill();
            draw();
        }

        // Tokens
        function addToken(c, i) {
            setMode('token');
            tokens.push({ x: 200, y: 200, color: c, icon: i, owner: null });
            draw();
        }

        function addCustomToken() {
            setMode('token');
            const i = prompt('Emoji:', '‚öîÔ∏è') || '‚öîÔ∏è';
            const c = prompt('Color:', '#e74c3c') || '#e74c3c';
            addToken(c, i);
        }

        // Zoom
        function setZoom(v) {
            zoom = v / 100;
            document.getElementById('zoomValue').textContent = Math.round(v) + '%';
            draw();
        }

        // Canvas Interaction
        canvas.addEventListener('mousedown', e => {
            const rect = canvas.getBoundingClientRect();
            const mx = (e.clientX - rect.left - panX) / zoom;
            const my = (e.clientY - rect.top - panY) / zoom;

            if (currentMode === 'fog') {
                isDrawing = true;
                applyFog(mx, my);
                return;
            }

            if (currentMode === 'token' && (currentPlayer || isDM)) {
                dragToken = tokens.find(t => {
                    const dx = mx - t.x;
                    const dy = my - t.y;
                    return Math.sqrt(dx*dx + dy*dy) < 30;
                });

                if (dragToken) {
                    isDrawing = true;
                }
                return;
            }

            if (currentMode === 'map' || currentMode === 'assets') {
                lastX = e.clientX;
                lastY = e.clientY;
                isDrawing = true;
            }
        });

        canvas.addEventListener('mousemove', e => {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            const mx = (e.clientX - rect.left - panX) / zoom;
            const my = (e.clientY - rect.top - panY) / zoom;

            if (currentMode === 'fog') {
                applyFog(mx, my);
                return;
            }

            if (currentMode === 'token' && dragToken) {
                dragToken.x = mx;
                dragToken.y = my;
                draw();
                return;
            }

            if (currentMode === 'map' || currentMode === 'assets') {
                panX += e.clientX - lastX;
                panY += e.clientY - lastY;
                lastX = e.clientX;
                lastY = e.clientY;
                draw();
            }
        });

        canvas.addEventListener('mouseup', () => {
            isDrawing = false;
            dragToken = null;
        });

        canvas.addEventListener('dragover', e => e.preventDefault());
        canvas.addEventListener('drop', e => {
            e.preventDefault();
            try {
                const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                if (data.type === 'player') {
                    const rect = canvas.getBoundingClientRect();
                    const x = (e.clientX - rect.left - panX) / zoom;
                    const y = (e.clientY - rect.top - panY) / zoom;
                    tokens.push({ x, y, color: data.token.color, icon: data.token.icon, owner: currentPlayer });
                    draw();
                }
            } catch {}
        });

        // FIXED: Update save button state based on DM status
        function updateSaveButton() {
            const saveBtn = document.getElementById('saveBtn');
            if (!isDM) {
                saveBtn.disabled = true;
                saveBtn.style.opacity = '0.5';
                saveBtn.style.cursor = 'not-allowed';
                saveBtn.title = 'Only the DM can save the game';
            } else {
                saveBtn.disabled = false;
                saveBtn.style.opacity = '1';
                saveBtn.style.cursor = 'pointer';
                saveBtn.title = '';
            }
        }

        // DM
        function openDM() {
            document.getElementById('dmModal').classList.add('active');
        }

        function closeDMModal() {
            document.getElementById('dmModal').classList.remove('active');
            document.getElementById('dmError').classList.remove('show');
        }

        function dmLogin(e) {
            e.preventDefault();
            const user = document.getElementById('dmUser').value;
            const pass = document.getElementById('dmPass').value;
            if (user === 'Wizard' && pass === 'Wizard') {
                isDM = true;
                closeDMModal();
                document.getElementById('dmPanel').classList.add('open');
                renderPlayerRequests();
                updateSaveButton();  // Update save button when DM logs in
            } else {
                document.getElementById('dmError').classList.add('show');
            }
        }

        function closeDM() {
            document.getElementById('dmPanel').classList.remove('open');
        }

        // Player Verification System
        function showPlayerLogin() {
            document.getElementById('playerModal').classList.add('active');
        }

        function closePlayerModal() {
            document.getElementById('playerModal').classList.remove('active');
            document.getElementById('playerSuccess').classList.remove('show');
        }

        function requestPlayerLogin(e) {
            e.preventDefault();
            const name = document.getElementById('playerName').value;
            
            playerRequests.push({ name: name, timestamp: Date.now() });
            document.getElementById('playerSuccess').classList.add('show');
            
            // Hide the tooltip since player has submitted request
            const tooltip = document.getElementById('playerTooltip');
            if (tooltip) {
                tooltip.classList.add('hidden');
            }
            
            if (isDM) {
                renderPlayerRequests();
            }
            
            setTimeout(() => {
                closePlayerModal();
            }, 2000);
        }

        function renderPlayerRequests() {
            const container = document.getElementById('playerRequests');
            if (playerRequests.length === 0) {
                container.innerHTML = '<p style="color: var(--text-dim); font-size: 0.85rem;">No pending requests</p>';
                return;
            }
            
            container.innerHTML = playerRequests.map((req, idx) => `
                <div class="player-request">
                    <span>${req.name}</span>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-small btn-primary" onclick="approvePlayer(${idx})">‚úì</button>
                        <button class="btn btn-small" onclick="denyPlayer(${idx})">‚úï</button>
                    </div>
                </div>
            `).join('');
        }

        function approvePlayer(idx) {
            const player = playerRequests[idx];
            approvedPlayers.push(player.name);
            playerRequests.splice(idx, 1);
            renderPlayerRequests();
            
            // Notify player (in real app, this would be network call)
            if (document.getElementById('playerName').value === player.name) {
                activatePlayer(player.name);
            }
        }

        function denyPlayer(idx) {
            playerRequests.splice(idx, 1);
            renderPlayerRequests();
        }

        function activatePlayer(name) {
            currentPlayer = name;
            document.getElementById('playerNameDisplay').textContent = name;
            document.getElementById('playerBar').classList.add('show');
            document.getElementById('playerBtn').textContent = '‚úì';
        }

        function playerLogout() {
            currentPlayer = null;
            playerTokens = [];
            document.getElementById('playerBar').classList.remove('show');
            document.getElementById('playerBtn').textContent = 'üë§';
        }

        function createPlayerToken() {
            if (!currentPlayer) { showPlayerLogin(); return; }
            const i = prompt('Emoji:', '‚öîÔ∏è') || '‚öîÔ∏è';
            const c = prompt('Color:', '#e74c3c') || '#e74c3c';
            const t = { id: Date.now(), color: c, icon: i };
            playerTokens.push(t);
            renderPlayerTokens();
        }

        function renderPlayerTokens() {
            document.getElementById('playerTokens').innerHTML = playerTokens.map(t => `
                <div class="token" draggable="true" style="background: ${t.color};" 
                     ondragstart="dragPlayerToken(event, ${t.id})">${t.icon}</div>
            `).join('');
        }

        function dragPlayerToken(e, id) {
            const t = playerTokens.find(x => x.id === id);
            e.dataTransfer.setData('text/plain', JSON.stringify({ type: 'player', token: t }));
        }

        // FIXED: Save game now requires DM permission
        function saveGame() {
            if (!isDM) {
                alert('Only the Dungeon Master can save the game!');
                return;
            }
            
            const data = { tokens, gridCells: {}, fog: fogCanvas.toDataURL(), zoom, panX, panY, currentGridX, currentGridY };
            for (let key in gridCells) {
                data.gridCells[key] = gridCells[key].toDataURL();
            }
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'fractured-sky-' + Date.now() + '.json';
            a.click();
        }

        function loadGame() {
            document.getElementById('fileLoad').click();
        }

        function handleLoad(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                const data = JSON.parse(ev.target.result);
                tokens = data.tokens || [];
                zoom = data.zoom || 1;
                panX = data.panX || 0;
                panY = data.panY || 0;
                currentGridX = data.currentGridX || 0;
                currentGridY = data.currentGridY || 0;
                
                gridCells = {};
                for (let key in data.gridCells) {
                    const img = new Image();
                    img.onload = () => {
                        const cellCanvas = document.createElement('canvas');
                        cellCanvas.width = CELL_SIZE;
                        cellCanvas.height = CELL_SIZE;
                        const cellCtx = cellCanvas.getContext('2d');
                        cellCtx.drawImage(img, 0, 0);
                        gridCells[key] = cellCanvas;
                        draw();
                    };
                    img.src = data.gridCells[key];
                }
                
                if (data.fog) {
                    const img = new Image();
                    img.onload = () => {
                        fogCtx.clearRect(0, 0, fogCanvas.width, fogCanvas.height);
                        fogCtx.drawImage(img, 0, 0, fogCanvas.width, fogCanvas.height);
                        draw();
                    };
                    img.src = data.fog;
                }
                
                // Load the current cell into the map canvas
                const key = `${currentGridX},${currentGridY}`;
                if (gridCells[key]) {
                    mapCtx.clearRect(0, 0, mapCanvas.width, mapCanvas.height);
                    mapCtx.drawImage(gridCells[key], 0, 0);
                } else {
                    mapCtx.fillStyle = '#f5f5dc';
                    mapCtx.fillRect(0, 0, mapCanvas.width, mapCanvas.height);
                }
                
                document.getElementById('zoomSlider').value = zoom * 100;
                document.getElementById('zoomValue').textContent = Math.round(zoom * 100) + '%';
                updateGridDisplay();
                draw();
            };
            reader.readAsText(file);
        }

        init();
    </script>
</body>
</html>
